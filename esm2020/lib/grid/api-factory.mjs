import { of, Subject, EMPTY } from 'rxjs';
import { ChangeDetectorRef, ElementRef, Injector, IterableDiffers, ViewContainerRef } from '@angular/core';
import { ON_DESTROY, ON_CONSTRUCTED } from '@pebula/ngrid/core';
import { PblNgridPluginContext } from '../ext/plugin-control';
import { ColumnApi, PblColumnStore } from './column/management';
import { PblNgridColumnWidthCalc } from './column/width-logic/column-width-calc';
import { PblRowsApi } from './row/rows-api';
import { PblNgridCellFactoryResolver } from './row/cell-factory.service';
import { ContextApi } from './context/api';
import { bindGridToDataSource } from './bind-grid-to-datasource';
import { logicap } from './logicap/index';
export function createApis(grid, tokens) {
    return new InternalExtensionApi(grid, tokens);
}
class InternalExtensionApi {
    constructor(grid, tokens) {
        this.grid = grid;
        this.propChanged = this._propChanged = new Subject();
        this.config = tokens.config;
        this.registry = tokens.registry;
        this.element = tokens.elRef.nativeElement;
        if (tokens.dir) {
            this.dir = tokens.dir;
        }
        const { plugin, init } = this.createPlugin(tokens);
        this._create = init;
        this.plugin = plugin;
        this.events = plugin.events;
        this.columnStore = new PblColumnStore(this, tokens.injector.get(IterableDiffers));
        this.widthCalc = new PblNgridColumnWidthCalc(this);
        const cellFactory = tokens.injector.get(PblNgridCellFactoryResolver);
        this.rowsApi = new PblRowsApi(this, tokens.ngZone, cellFactory);
        this.columnApi = ColumnApi.create(this);
        this._contextApi = new ContextApi(this);
        this.logicaps = logicap(this);
        bindGridToDataSource(this);
        this.events.pipe(ON_DESTROY).subscribe(e => this._propChanged.complete());
        this.widthCalc
            .onWidthCalc
            .subscribe(rowWidth => {
            this._cdkTable.minWidth = rowWidth.minimumRowWidth;
            tokens.ngZone.run(() => {
                this.rowsApi.syncRows('header');
                this.plugin.emitEvent({ source: 'grid', kind: 'onResizeRow' });
            });
        });
    }
    get cdkTable() { return this._cdkTable; }
    get contextApi() { return this._contextApi || (this._contextApi = new ContextApi(this)); }
    get viewport() { return this._viewPort; }
    get pluginCtrl() { return this.plugin.controller; }
    getDirection() {
        return this.dir?.value ?? 'ltr';
    }
    directionChange() {
        return this.dir?.change.asObservable() ?? EMPTY;
    }
    onConstructed(fn) {
        if (!this._create) {
            of(false);
        }
        else {
            this.events.pipe(ON_CONSTRUCTED).subscribe(fn);
        }
    }
    onInit(fn) {
        this.plugin.controller.onInit().subscribe(fn);
    }
    setCdkTable(cdkTable) {
        this._cdkTable = cdkTable;
        const globalCreateEvent = this._create;
        delete this._create;
        this.plugin.emitEvent({ source: 'grid', kind: 'onConstructed' });
        globalCreateEvent();
    }
    setViewport(viewport) {
        this._viewPort = viewport;
    }
    notifyPropChanged(source, key, prev, curr) {
        if (prev !== curr) {
            this._propChanged.next({ source, key, prev, curr });
        }
    }
    createPlugin(tokens) {
        // Create an injector for the extensions/plugins
        // This injector allow plugins (that choose so) to provide a factory function for runtime use.
        // I.E: as if they we're created by angular via template...
        // This allows seamless plugin-to-plugin dependencies without requiring specific template syntax.
        // And also allows auto plugin binding (app wide) without the need for template syntax.
        const pluginInjector = Injector.create({
            providers: [
                { provide: ViewContainerRef, useValue: tokens.vcRef },
                { provide: ElementRef, useValue: tokens.elRef },
                { provide: ChangeDetectorRef, useValue: tokens.cdRef },
            ],
            parent: tokens.injector,
        });
        return PblNgridPluginContext.create(pluginInjector, this);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL25ncmlkL3NyYy9saWIvZ3JpZC9hcGktZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFVLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR25ILE9BQU8sRUFBeUMsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR3ZHLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTlELE9BQU8sRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFHakYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLE9BQU8sRUFBWSxNQUFNLGlCQUFpQixDQUFDO0FBYXBELE1BQU0sVUFBVSxVQUFVLENBQUksSUFBMEIsRUFBRSxNQUE2QjtJQUNyRixPQUFPLElBQUksb0JBQW9CLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFFRCxNQUFNLG9CQUFvQjtJQXlCeEIsWUFBNEIsSUFBMEIsRUFBRSxNQUE2QjtRQUF6RCxTQUFJLEdBQUosSUFBSSxDQUFzQjtRQUNwRCxJQUFJLENB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SSxFQUFRLENBQUMsQ0FBQztTQUMxRDtJQUNILENBQUM7SUFFTyxZQUFZLENBQUMsTUFBNkI7UUFDaEQsZ0RBQWdEO1FBQ2hELDhGQUE4RjtRQUM5RiwyREFBMkQ7UUFDM0QsaUdBQWlHO1FBQ2pHLHVGQUF1RjtRQUN2RixNQUFNLGNBQWMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ3JDLFNBQVMsRUFBRTtnQkFDVCxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRTtnQkFDckQsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFO2dCQUMvQyxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRTthQUN2RDtZQUNELE1BQU0sRUFBRSxNQUFNLENBQUMsUUFBUTtTQUN4QixDQUFDLENBQUM7UUFDSCxPQUFPLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIEVNUFRZIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgRWxlbWVudFJlZiwgSW5qZWN0b3IsIEl0ZXJhYmxlRGlmZmVycywgTmdab25lLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEaXJlY3Rpb24sIERpcmVjdGlvbmFsaXR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2JpZGknO1xuXG5pbXBvcnQgeyBQYmxOZ3JpZENvbmZpZ1NlcnZpY2UsIFBibE5ncmlkRXZlbnRzLCBPTl9ERVNUUk9ZLCBPTl9DT05TVFJVQ1RFRCB9IGZyb20gJ0BwZWJ1bGEvbmdyaWQvY29yZSc7XG5pbXBvcnQgeyBQYmxOZ3JpZFJlZ2lzdHJ5U2VydmljZSB9IGZyb20gJy4vcmVnaXN0cnkvcmVnaXN0cnkuc2VydmljZSc7XG5pbXBvcnQgeyBQYmxOZ3JpZEludGVybmFsRXh0ZW5zaW9uQXBpIH0gZnJvbSAnLi4vZXh0L2dyaWQtZXh0LWFwaSc7XG5pbXBvcnQgeyBQYmxOZ3JpZFBsdWdpbkNvbnRleHQgfSBmcm9tICcuLi9leHQvcGx1Z2luLWNvbnRyb2wnO1xuaW1wb3J0IHsgT25Qcm9wQ2hhbmdlZEV2ZW50IH0gZnJvbSAnLi4vZXh0L3R5cGVzJztcbmltcG9ydCB7IENvbHVtbkFwaSwgUGJsQ29sdW1uU3RvcmUgfSBmcm9tICcuL2NvbHVtbi9tYW5hZ2VtZW50JztcbmltcG9ydCB7IFBibE5ncmlkQ29sdW1uV2lkdGhDYWxjIH0gZnJvbSAnLi9jb2x1bW4vd2lkdGgtbG9naWMvY29sdW1uLXdpZHRoLWNhbGMnO1xuaW1wb3J0IHsgUGJsTmdyaWRDb21wb25lbnQgfSBmcm9tICcuL25ncmlkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQYmxDZGtUYWJsZUNvbXBvbmVudCB9IGZyb20gJy4vcGJsLWNkay10YWJsZS9wYmwtY2RrLXRhYmxlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQYmxSb3dzQXBpIH0gZnJvbSAnLi9yb3cvcm93cy1hcGknO1xuaW1wb3J0IHsgUGJsTmdyaWRDZWxsRmFjdG9yeVJlc29sdmVyIH0gZnJvbSAnLi9yb3cvY2VsbC1mYWN0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29udGV4dEFwaSB9IGZyb20gJy4vY29udGV4dC9hcGknO1xuaW1wb3J0IHsgUGJsTmdyaWRNZXRhUm93U2VydmljZSB9IGZyb20gJy4vbWV0YS1yb3dzL21ldGEtcm93LnNlcnZpY2UnO1xuaW1wb3J0IHsgUGJsQ2RrVmlydHVhbFNjcm9sbFZpZXdwb3J0Q29tcG9uZW50IH0gZnJvbSAnLi9mZWF0dXJlcy92aXJ0dWFsLXNjcm9sbC92aXJ0dWFsLXNjcm9sbC12aWV3cG9ydC5jb21wb25lbnQnO1xuaW1wb3J0IHsgYmluZEdyaWRUb0RhdGFTb3VyY2UgfSBmcm9tICcuL2JpbmQtZ3JpZC10by1kYXRhc291cmNlJztcbmltcG9ydCB7IGxvZ2ljYXAsIExvZ2ljYXBzIH0gZnJvbSAnLi9sb2dpY2FwL2luZGV4JztcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1aXJlZEFuZ3VsYXJUb2tlbnMge1xuICBuZ1pvbmU6IE5nWm9uZTtcbiAgaW5qZWN0b3I6IEluamVjdG9yO1xuICB2Y1JlZjogVmlld0NvbnRhaW5lclJlZjtcbiAgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmO1xuICBlbFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD47XG4gIGNvbmZpZzogUGJsTmdyaWRDb25maWdTZXJ2aWNlO1xuICByZWdpc3RyeTogUGJsTmdyaWRSZWdpc3RyeVNlcnZpY2U7XG4gIGRpcj86IERpcmVjdGlvbmFsaXR5O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQXBpczxUPihncmlkOiBQYmxOZ3JpZENvbXBvbmVudDxUPiwgdG9rZW5zOiBSZXF1aXJlZEFuZ3VsYXJUb2tlbnMpIHtcbiAgcmV0dXJuIG5ldyBJbnRlcm5hbEV4dGVuc2lvbkFwaShncmlkLCB0b2tlbnMpO1xufVxuXG5jbGFzcyBJbnRlcm5hbEV4dGVuc2lvbkFwaTxUID0gYW55PiBpbXBsZW1lbnRzIFBibE5ncmlkSW50ZXJuYWxFeHRlbnNpb25BcGk8VD4ge1xuICByZWFkb25seSBjb25maWc6IFBibE5ncmlkQ29uZmlnU2VydmljZTtcbiAgcmVhZG9ubHkgcmVnaXN0cnk6IFBibE5ncmlkUmVnaXN0cnlTZXJ2aWNlO1xuICByZWFkb25seSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgcmVhZG9ubHkgcHJvcENoYW5nZWQ6IE9ic2VydmFibGU8T25Qcm9wQ2hhbmdlZEV2ZW50PjtcbiAgcmVhZG9ubHkgY29sdW1uU3RvcmU6IFBibENvbHVtblN0b3JlO1xuICByZWFkb25seSBjb2x1bW5BcGk6IENvbHVtbkFwaTxUPjtcbiAgcmVhZG9ubHkgcm93c0FwaTogUGJsUm93c0FwaTxUPjtcbiAgcmVhZG9ubHkgZXZlbnRzOiBPYnNlcnZhYmxlPFBibE5ncmlkRXZlbnRzPjtcbiAgcmVhZG9ubHkgcGx1Z2luOiBQYmxOZ3JpZFBsdWdpbkNvbnRleHQ7XG4gIHJlYWRvbmx5IHdpZHRoQ2FsYzogUGJsTmdyaWRDb2x1bW5XaWR0aENhbGM7XG4gIHJlYWRvbmx5IGxvZ2ljYXBzOiBMb2dpY2FwcztcblxuICBnZXQgY2RrVGFibGUoKSB7IHJldHVybiB0aGlzLl9jZGtUYWJsZTsgfVxuICBnZXQgY29udGV4dEFwaSgpIHsgcmV0dXJuIHRoaXMuX2NvbnRleHRBcGkgfHwgKHRoaXMuX2NvbnRleHRBcGkgPSBuZXcgQ29udGV4dEFwaTxUPih0aGlzKSk7IH1cbiAgZ2V0IHZpZXdwb3J0KCk6IFBibENka1ZpcnR1YWxTY3JvbGxWaWV3cG9ydENvbXBvbmVudCB7IHJldHVybiB0aGlzLl92aWV3UG9ydDsgfVxuICBnZXQgcGx1Z2luQ3RybCgpIHsgcmV0dXJuIHRoaXMucGx1Z2luLmNvbnRyb2xsZXI7IH1cblxuICBwcml2YXRlIF9jZGtUYWJsZTogUGJsQ2RrVGFibGVDb21wb25lbnQ8VD47XG4gIHByaXZhdGUgX2NvbnRleHRBcGk6IENvbnRleHRBcGk8VD47XG4gIHByaXZhdGUgX3ZpZXdQb3J0OiBQYmxDZGtWaXJ0dWFsU2Nyb2xsVmlld3BvcnRDb21wb25lbnQ7XG4gIHByaXZhdGUgX2NyZWF0ZTogKCkgPT4gdm9pZDtcbiAgcHJpdmF0ZSBkaXI/OiBEaXJlY3Rpb25hbGl0eTtcbiAgcHJpdmF0ZSByZWFkb25seSBfcHJvcENoYW5nZWQ6IFN1YmplY3Q8T25Qcm9wQ2hhbmdlZEV2ZW50PjtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgZ3JpZDogUGJsTmdyaWRDb21wb25lbnQ8VD4sIHRva2VuczogUmVxdWlyZWRBbmd1bGFyVG9rZW5zKSB7XG4gICAgdGhpcy5wcm9wQ2hhbmdlZCA9IHRoaXMuX3Byb3BDaGFuZ2VkID0gbmV3IFN1YmplY3Q8T25Qcm9wQ2hhbmdlZEV2ZW50PigpO1xuXG4gICAgdGhpcy5jb25maWcgPSB0b2tlbnMuY29uZmlnO1xuICAgIHRoaXMucmVnaXN0cnkgPSB0b2tlbnMucmVnaXN0cnk7XG4gICAgdGhpcy5lbGVtZW50ID0gdG9rZW5zLmVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgaWYgKHRva2Vucy5kaXIpIHtcbiAgICAgIHRoaXMuZGlyID0gdG9rZW5zLmRpcjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBsdWdpbiwgaW5pdCB9ID0gdGhpcy5jcmVhdGVQbHVnaW4odG9rZW5zKTtcbiAgICB0aGlzLl9jcmVhdGUgPSBpbml0O1xuICAgIHRoaXMucGx1Z2luID0gcGx1Z2luO1xuICAgIHRoaXMuZXZlbnRzID0gcGx1Z2luLmV2ZW50cztcbiAgICB0aGlzLmNvbHVtblN0b3JlID0gbmV3IFBibENvbHVtblN0b3JlKHRoaXMsIHRva2Vucy5pbmplY3Rvci5nZXQoSXRlcmFibGVEaWZmZXJzKSk7XG4gICAgdGhpcy53aWR0aENhbGMgPSBuZXcgUGJsTmdyaWRDb2x1bW5XaWR0aENhbGModGhpcyk7XG5cbiAgICBjb25zdCBjZWxsRmFjdG9yeSA9IHRva2Vucy5pbmplY3Rvci5nZXQoUGJsTmdyaWRDZWxsRmFjdG9yeVJlc29sdmVyKTtcbiAgICB0aGlzLnJvd3NBcGkgPSBuZXcgUGJsUm93c0FwaTxUPih0aGlzLCB0b2tlbnMubmdab25lLCBjZWxsRmFjdG9yeSk7XG5cbiAgICB0aGlzLmNvbHVtbkFwaSA9IENvbHVtbkFwaS5jcmVhdGU8VD4odGhpcyk7XG4gICAgdGhpcy5fY29udGV4dEFwaSA9IG5ldyBDb250ZXh0QXBpPFQ+KHRoaXMpO1xuICAgIHRoaXMubG9naWNhcHMgPSBsb2dpY2FwKHRoaXMpO1xuXG4gICAgYmluZEdyaWRUb0RhdGFTb3VyY2UodGhpcyk7XG5cbiAgICB0aGlzLmV2ZW50cy5waXBlKE9OX0RFU1RST1kpLnN1YnNjcmliZSggZSA9PiB0aGlzLl9wcm9wQ2hhbmdlZC5jb21wbGV0ZSgpICk7XG5cbiAgICB0aGlzLndpZHRoQ2FsY1xuICAgICAgLm9uV2lkdGhDYWxjXG4gICAgICAuc3Vic2NyaWJlKCByb3dXaWR0aCA9PiB7XG4gICAgICAgIHRoaXMuX2Nka1RhYmxlLm1pbldpZHRoID0gcm93V2lkdGgubWluaW11bVJvd1dpZHRoO1xuXG4gICAgICAgIHRva2Vucy5uZ1pvbmUucnVuKCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yb3dzQXBpLnN5bmNSb3dzKCdoZWFkZXInKTtcbiAgICAgICAgICB0aGlzLnBsdWdpbi5lbWl0RXZlbnQoeyBzb3VyY2U6ICdncmlkJywga2luZDogJ29uUmVzaXplUm93JyB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGdldERpcmVjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5kaXI/LnZhbHVlID8/ICdsdHInO1xuICB9XG5cbiAgZGlyZWN0aW9uQ2hhbmdlKCk6IE9ic2VydmFibGU8RGlyZWN0aW9uPiB7XG4gICAgcmV0dXJuIHRoaXMuZGlyPy5jaGFuZ2UuYXNPYnNlcnZhYmxlKCkgPz8gRU1QVFk7XG4gIH1cblxuICBvbkNvbnN0cnVjdGVkKGZuOiAoKSA9PiB2b2lkKSB7XG4gICAgaWYgKCF0aGlzLl9jcmVhdGUpIHtcbiAgICAgIG9mKGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5ldmVudHMucGlwZShPTl9DT05TVFJVQ1RFRCkuc3Vic2NyaWJlKGZuKTtcbiAgICB9XG4gIH1cblxuICBvbkluaXQoZm46ICgpID0+IHZvaWQpIHtcbiAgICB0aGlzLnBsdWdpbi5jb250cm9sbGVyLm9uSW5pdCgpLnN1YnNjcmliZShmbik7XG4gIH1cblxuICBzZXRDZGtUYWJsZShjZGtUYWJsZTogUGJsQ2RrVGFibGVDb21wb25lbnQ8VD4pIHtcbiAgICB0aGlzLl9jZGtUYWJsZSA9IGNka1RhYmxlO1xuICAgIGNvbnN0IGdsb2JhbENyZWF0ZUV2ZW50ID0gdGhpcy5fY3JlYXRlO1xuICAgIGRlbGV0ZSB0aGlzLl9jcmVhdGU7XG4gICAgdGhpcy5wbHVnaW4uZW1pdEV2ZW50KHsgc291cmNlOiAnZ3JpZCcsIGtpbmQ6ICdvbkNvbnN0cnVjdGVkJyB9KTtcbiAgICBnbG9iYWxDcmVhdGVFdmVudCgpO1xuICB9XG5cbiAgc2V0Vmlld3BvcnQodmlld3BvcnQ6IFBibENka1ZpcnR1YWxTY3JvbGxWaWV3cG9ydENvbXBvbmVudCkge1xuICAgIHRoaXMuX3ZpZXdQb3J0ID0gdmlld3BvcnQ7XG4gIH1cblxuICBub3RpZnlQcm9wQ2hhbmdlZChzb3VyY2UsIGtleSwgcHJldiwgY3Vycikge1xuICAgIGlmIChwcmV2ICE9PSBjdXJyKSB7XG4gICAgICB0aGlzLl9wcm9wQ2hhbmdlZC5uZXh0KHtzb3VyY2UsIGtleSwgcHJldiwgY3Vycn0gYXMgYW55KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVBsdWdpbih0b2tlbnM6IFJlcXVpcmVkQW5ndWxhclRva2Vucykge1xuICAgIC8vIENyZWF0ZSBhbiBpbmplY3RvciBmb3IgdGhlIGV4dGVuc2lvbnMvcGx1Z2luc1xuICAgIC8vIFRoaXMgaW5qZWN0b3IgYWxsb3cgcGx1Z2lucyAodGhhdCBjaG9vc2Ugc28pIHRvIHByb3ZpZGUgYSBmYWN0b3J5IGZ1bmN0aW9uIGZvciBydW50aW1lIHVzZS5cbiAgICAvLyBJLkU6IGFzIGlmIHRoZXkgd2UncmUgY3JlYXRlZCBieSBhbmd1bGFyIHZpYSB0ZW1wbGF0ZS4uLlxuICAgIC8vIFRoaXMgYWxsb3dzIHNlYW1sZXNzIHBsdWdpbi10by1wbHVnaW4gZGVwZW5kZW5jaWVzIHdpdGhvdXQgcmVxdWlyaW5nIHNwZWNpZmljIHRlbXBsYXRlIHN5bnRheC5cbiAgICAvLyBBbmQgYWxzbyBhbGxvd3MgYXV0byBwbHVnaW4gYmluZGluZyAoYXBwIHdpZGUpIHdpdGhvdXQgdGhlIG5lZWQgZm9yIHRlbXBsYXRlIHN5bnRheC5cbiAgICBjb25zdCBwbHVnaW5JbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgeyBwcm92aWRlOiBWaWV3Q29udGFpbmVyUmVmLCB1c2VWYWx1ZTogdG9rZW5zLnZjUmVmIH0sXG4gICAgICAgIHsgcHJvdmlkZTogRWxlbWVudFJlZiwgdXNlVmFsdWU6IHRva2Vucy5lbFJlZiB9LFxuICAgICAgICB7IHByb3ZpZGU6IENoYW5nZURldGVjdG9yUmVmLCB1c2VWYWx1ZTogdG9rZW5zLmNkUmVmIH0sXG4gICAgICBdLFxuICAgICAgcGFyZW50OiB0b2tlbnMuaW5qZWN0b3IsXG4gICAgfSk7XG4gICAgcmV0dXJuIFBibE5ncmlkUGx1Z2luQ29udGV4dC5jcmVhdGUocGx1Z2luSW5qZWN0b3IsIHRoaXMpO1xuICB9XG59XG4iXX0=