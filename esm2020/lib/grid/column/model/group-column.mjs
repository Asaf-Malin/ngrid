import { PblMetaColumn } from './meta-column';
const PBL_NGRID_COLUMN_GROUP_MARK = Symbol('PblColumnGroup');
const CLONE_PROPERTIES = [];
export function isPblColumnGroup(def) {
    return def instanceof PblColumnGroup || (def && def[PBL_NGRID_COLUMN_GROUP_MARK] === true);
}
function getId(value) {
    return typeof value === 'string' ? value : value.id;
}
export class PblColumnGroupStore {
    constructor() {
        this.store = new Map();
        this._all = [];
    }
    get all() { return this._all; }
    /**
     * Attach a column to a group.
     */
    attach(group, column) {
        const g = this._find(group);
        if (g) {
            g.activeColumns.add(getId(column));
            return true;
        }
        return false;
    }
    /**
     * Detach a column from a group.
     */
    detach(group, column) {
        const g = this._find(group);
        if (g) {
            return g.activeColumns.delete(getId(column));
        }
        return false;
    }
    /**
     * Returns a list of `PblColumnGroup` that does not have columns attached.
     */
    findGhosts() {
        return Array.from(this.store.values())
            .filter(item => item.activeColumns.size === 0)
            .map(item => item.group);
    }
    add(group) {
        this.store.set(group.id, { group, activeColumns: new Set() });
        this.updateAll();
    }
    remove(group) {
        const g = this.find(group);
        if (g && this.store.delete(g.id)) {
            this.updateAll();
            return true;
        }
        return false;
    }
    find(group) {
        const g = this._find(group);
        if (g) {
            return g.group;
        }
    }
    clone() {
        const c = new PblColumnGroupStore();
        c.store = new Map(this.store);
        c.updateAll();
        return c;
    }
    _find(group) {
        return this.store.get(getId(group));
    }
    updateAll() {
        this._all = Array.from(this.store.values()).map(item => item.group);
    }
}
export class PblColumnGroup extends PblMetaColumn {
    constructor(def, columns, placeholder = false) {
        super(isPblColumnGroup(def)
            ? def
            : { id: `group-${def.columnIds.join('.')}-row-${def.rowIndex}`, kind: 'header', ...def });
        this.placeholder = placeholder;
        this[PBL_NGRID_COLUMN_GROUP_MARK] = true;
        this.columnIds = def.columnIds;
        this.columns = columns;
        for (const c of columns) {
            c.markInGroup(this);
        }
        for (const prop of CLONE_PROPERTIES) {
            if (prop in def) {
                this[prop] = def[prop];
            }
        }
    }
    //#endregion PblColumnGroupDefinition
    /**
     * Returns the visible state of the column.
     * The column is visible if AT LEAST ONE child column is visible (i.e. not hidden)
     */
    get isVisible() {
        return this.columns.some(c => !c.hidden);
    }
    static extendProperty(name) {
        if (CLONE_PROPERTIES.indexOf(name) === -1) {
            CLONE_PROPERTIES.push(name);
        }
    }
    createSlave(columns = []) {
        const slave = new PblColumnGroup({ ...this, id: this.id + '-slave' + Date.now() }, columns);
        slave.slaveOf = this;
        Object.defineProperty(slave, 'template', { get: function () { return this.slaveOf.template; }, set: function (value) { } });
        return slave;
    }
    replace(newColumn) {
        const { id } = newColumn;
        const idx = this.columns.findIndex(c => c.id === id);
        if (idx > -1) {
            this.columns.splice(idx, 1, newColumn);
            return true;
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXAtY29sdW1uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3JpZC9zcmMvbGliL2dyaWQvY29sdW1uL21vZGVsL2dyb3VwLWNvbHVtbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzlDLE1BQU0sMkJBQTJCLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDN0QsTUFBTSxnQkFBZ0IsR0FBZ0MsRUFBRSxDQUFDO0FBRXpELE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxHQUFRO0lBQ3ZDLE9BQU8sR0FBRyxZQUFZLGNBQWMsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsMkJBQTJCLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztBQUM3RixDQUFDO0FBRUQsU0FBUyxLQUFLLENBQUMsS0FBOEI7SUFDM0MsT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztBQUN0RCxDQUFDO0FBRUQsTUFBTSxPQUFPLG1CQUFtQjtJQUFoQztRQUdVLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBa0UsQ0FBQztRQUNsRixTQUFJLEdBQXFCLEVBQUUsQ0FBQztJQXFFdEMsQ0FBQztJQXhFQyxJQUFJLEdBQUcsS0FBdUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUtqRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUE4QixFQUFFLE1BQTBCO1FBQy9ELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLEVBQUU7WUFDTCxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNuQyxP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YyxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxHQUFHLEVBQUUsY0FBYSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxVQUFTLEtBQUssSUFBRyxDQUFDLEVBQUUsQ0FBRSxDQUFDO1FBQzFILE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELE9BQU8sQ0FBQyxTQUFvQjtRQUMxQixNQUFNLEVBQUUsRUFBRSxFQUFFLEdBQUcsU0FBUyxDQUFDO1FBQ3pCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUUsQ0FBQztRQUN2RCxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsRUFBRTtZQUNaLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDdkMsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGJsQ29sdW1uR3JvdXBEZWZpbml0aW9uIH0gZnJvbSAnQHBlYnVsYS9uZ3JpZC9jb3JlJztcbmltcG9ydCB7IFBibE1ldGFDb2x1bW4gfSBmcm9tICcuL21ldGEtY29sdW1uJztcbmltcG9ydCB7IFBibENvbHVtbiB9IGZyb20gJy4vY29sdW1uJztcblxuY29uc3QgUEJMX05HUklEX0NPTFVNTl9HUk9VUF9NQVJLID0gU3ltYm9sKCdQYmxDb2x1bW5Hcm91cCcpO1xuY29uc3QgQ0xPTkVfUFJPUEVSVElFUzogQXJyYXk8a2V5b2YgUGJsQ29sdW1uR3JvdXA+ID0gW107XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1BibENvbHVtbkdyb3VwKGRlZjogYW55KTogZGVmIGlzIFBibENvbHVtbkdyb3VwIHtcbiAgcmV0dXJuIGRlZiBpbnN0YW5jZW9mIFBibENvbHVtbkdyb3VwIHx8IChkZWYgJiYgZGVmW1BCTF9OR1JJRF9DT0xVTU5fR1JPVVBfTUFSS10gPT09IHRydWUpO1xufVxuXG5mdW5jdGlvbiBnZXRJZCh2YWx1ZTogc3RyaW5nIHwgeyBpZDogc3RyaW5nIH0pOiBzdHJpbmcge1xuICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlIDogdmFsdWUuaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBQYmxDb2x1bW5Hcm91cFN0b3JlIHtcbiAgZ2V0IGFsbCgpOiBQYmxDb2x1bW5Hcm91cFtdIHsgcmV0dXJuIHRoaXMuX2FsbDsgfVxuXG4gIHByaXZhdGUgc3RvcmUgPSBuZXcgTWFwPHN0cmluZywgeyBncm91cDogUGJsQ29sdW1uR3JvdXA7IGFjdGl2ZUNvbHVtbnM6IFNldDxzdHJpbmc+OyB9PigpO1xuICBwcml2YXRlIF9hbGw6IFBibENvbHVtbkdyb3VwW10gPSBbXTtcblxuICAvKipcbiAgICogQXR0YWNoIGEgY29sdW1uIHRvIGEgZ3JvdXAuXG4gICAqL1xuICBhdHRhY2goZ3JvdXA6IHN0cmluZyB8IFBibENvbHVtbkdyb3VwLCBjb2x1bW46IHN0cmluZyB8IFBibENvbHVtbik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGcgPSB0aGlzLl9maW5kKGdyb3VwKTtcbiAgICBpZiAoZykge1xuICAgICAgZy5hY3RpdmVDb2x1bW5zLmFkZChnZXRJZChjb2x1bW4pKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogRGV0YWNoIGEgY29sdW1uIGZyb20gYSBncm91cC5cbiAgICovXG4gIGRldGFjaChncm91cDogc3RyaW5nIHwgUGJsQ29sdW1uR3JvdXAsIGNvbHVtbjogc3RyaW5nIHwgUGJsQ29sdW1uKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZyA9IHRoaXMuX2ZpbmQoZ3JvdXApO1xuICAgIGlmIChnKSB7XG4gICAgICByZXR1cm4gZy5hY3RpdmVDb2x1bW5zLmRlbGV0ZShnZXRJZChjb2x1bW4pKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBsaXN0IG9mIGBQYmxDb2x1bW5Hcm91cGAgdGhhdCBkb2VzIG5vdCBoYXZlIGNvbHVtbnMgYXR0YWNoZWQuXG4gICAqL1xuICBmaW5kR2hvc3RzKCk6IFBibENvbHVtbkdyb3VwW10ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuc3RvcmUudmFsdWVzKCkpXG4gICAgICAuZmlsdGVyKCBpdGVtID0+IGl0ZW0uYWN0aXZlQ29sdW1ucy5zaXplID09PSAwIClcbiAgICAgIC5tYXAoIGl0ZW0gPT4gaXRlbS5ncm91cCApO1xuICB9XG5cbiAgYWRkKGdyb3VwOiBQYmxDb2x1bW5Hcm91cCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcmUuc2V0KGdyb3VwLmlkLCB7IGdyb3VwLCBhY3RpdmVDb2x1bW5zOiBuZXcgU2V0PHN0cmluZz4oKSB9KTtcbiAgICB0aGlzLnVwZGF0ZUFsbCgpO1xuICB9XG5cbiAgcmVtb3ZlKGdyb3VwOiBzdHJpbmcgfCBQYmxDb2x1bW5Hcm91cCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGcgPSB0aGlzLmZpbmQoZ3JvdXApO1xuICAgIGlmIChnICYmIHRoaXMuc3RvcmUuZGVsZXRlKGcuaWQpKSB7XG4gICAgICB0aGlzLnVwZGF0ZUFsbCgpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGZpbmQoZ3JvdXA6IHN0cmluZyB8IFBibENvbHVtbkdyb3VwKTogUGJsQ29sdW1uR3JvdXAgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGcgPSB0aGlzLl9maW5kKGdyb3VwKTtcbiAgICBpZiAoZykge1xuICAgICAgcmV0dXJuIGcuZ3JvdXA7XG4gICAgfVxuICB9XG5cbiAgY2xvbmUoKTogUGJsQ29sdW1uR3JvdXBTdG9yZSB7XG4gICAgY29uc3QgYyA9IG5ldyBQYmxDb2x1bW5Hcm91cFN0b3JlKCk7XG4gICAgYy5zdG9yZSA9IG5ldyBNYXA8c3RyaW5nLCB7IGdyb3VwOiBQYmxDb2x1bW5Hcm91cDsgYWN0aXZlQ29sdW1uczogU2V0PHN0cmluZz47IH0+KHRoaXMuc3RvcmUpO1xuICAgIGMudXBkYXRlQWxsKCk7XG4gICAgcmV0dXJuIGM7XG4gIH1cblxuICBwcml2YXRlIF9maW5kKGdyb3VwOiBzdHJpbmcgfCBQYmxDb2x1bW5Hcm91cCk6IHsgZ3JvdXA6IFBibENvbHVtbkdyb3VwOyBhY3RpdmVDb2x1bW5zOiBTZXQ8c3RyaW5nPjsgfSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUuZ2V0KGdldElkKGdyb3VwKSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUFsbCgpOiB2b2lkIHtcbiAgICB0aGlzLl9hbGwgPSBBcnJheS5mcm9tKHRoaXMuc3RvcmUudmFsdWVzKCkpLm1hcCggaXRlbSA9PiBpdGVtLmdyb3VwICk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBibENvbHVtbkdyb3VwIGV4dGVuZHMgUGJsTWV0YUNvbHVtbiBpbXBsZW1lbnRzIFBibENvbHVtbkdyb3VwRGVmaW5pdGlvbiB7XG5cbiAgY29sdW1uSWRzOiBzdHJpbmdbXTtcbiAgLy8jZW5kcmVnaW9uIFBibENvbHVtbkdyb3VwRGVmaW5pdGlvblxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB2aXNpYmxlIHN0YXRlIG9mIHRoZSBjb2x1bW4uXG4gICAqIFRoZSBjb2x1bW4gaXMgdmlzaWJsZSBpZiBBVCBMRUFTVCBPTkUgY2hpbGQgY29sdW1uIGlzIHZpc2libGUgKGkuZS4gbm90IGhpZGRlbilcbiAgICovXG4gIGdldCBpc1Zpc2libGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY29sdW1ucy5zb21lKCBjID0+ICFjLmhpZGRlbiApO1xuICB9XG5cbiAgLyoqXG4gICAqIFdoZW4gc2V0LCB0aGlzIGNvbHVtbiBpcyBhIGNsb25lZCBjb2x1bW4gb2YgYW4gZXhpc3RpbmcgY29sdW1uIGNhdXNlZCBieSBhIHNwbGl0LlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHNsYXZlT2Y/OiBQYmxDb2x1bW5Hcm91cDtcblxuICAvKiogQGludGVybmFsICovXG4gIHJlYWRvbmx5IGNvbHVtbnM6IFBibENvbHVtbltdO1xuXG4gIGNvbnN0cnVjdG9yKGRlZjogUGJsQ29sdW1uR3JvdXAgfCBQYmxDb2x1bW5Hcm91cERlZmluaXRpb24sIGNvbHVtbnM6IFBibENvbHVtbltdLCBwdWJsaWMgcmVhZG9ubHkgcGxhY2Vob2xkZXIgPSBmYWxzZSkge1xuICAgIHN1cGVyKGlzUGJsQ29sdW1uR3JvdXAoZGVmKVxuICAgICAgPyBkZWZcbiAgICAgIDogeyBpZDogYGdyb3VwLSR7ZGVmLmNvbHVtbklkcy5qb2luKCcuJyl9LXJvdy0ke2RlZi5yb3dJbmRleH1gLCBraW5kOiAnaGVhZGVyJyBhcyAnaGVhZGVyJywgLi4uKGRlZiBhcyBhbnkpIH1cbiAgICApO1xuICAgIHRoaXNbUEJMX05HUklEX0NPTFVNTl9HUk9VUF9NQVJLXSA9IHRydWU7XG4gICAgdGhpcy5jb2x1bW5JZHMgPSBkZWYuY29sdW1uSWRzO1xuICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbnM7XG5cbiAgICBmb3IgKGNvbnN0IGMgb2YgY29sdW1ucykge1xuICAgICAgYy5tYXJrSW5Hcm91cCh0aGlzKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHByb3Agb2YgQ0xPTkVfUFJPUEVSVElFUykge1xuICAgICAgaWYgKHByb3AgaW4gZGVmKSB7XG4gICAgICAgIHRoaXNbcHJvcCBhcyBhbnldID0gZGVmW3Byb3BdXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGV4dGVuZFByb3BlcnR5KG5hbWU6IGtleW9mIFBibENvbHVtbkdyb3VwKTogdm9pZCB7XG4gICAgaWYgKENMT05FX1BST1BFUlRJRVMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgIENMT05FX1BST1BFUlRJRVMucHVzaChuYW1lKTtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVTbGF2ZShjb2x1bW5zOiBQYmxDb2x1bW5bXSA9IFtdKTogUGJsQ29sdW1uR3JvdXAge1xuICAgIGNvbnN0IHNsYXZlID0gbmV3IFBibENvbHVtbkdyb3VwKHsuLi50aGlzLCBpZDogdGhpcy5pZCArICctc2xhdmUnICsgRGF0ZS5ub3coKX0sIGNvbHVtbnMpO1xuICAgIHNsYXZlLnNsYXZlT2YgPSB0aGlzO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzbGF2ZSwgJ3RlbXBsYXRlJywgeyBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5zbGF2ZU9mLnRlbXBsYXRlOyB9LCBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7fSB9ICk7XG4gICAgcmV0dXJuIHNsYXZlO1xuICB9XG5cbiAgcmVwbGFjZShuZXdDb2x1bW46IFBibENvbHVtbik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgaWQgfSA9IG5ld0NvbHVtbjtcbiAgICBjb25zdCBpZHggPSB0aGlzLmNvbHVtbnMuZmluZEluZGV4KCBjID0+IGMuaWQgPT09IGlkICk7XG4gICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICB0aGlzLmNvbHVtbnMuc3BsaWNlKGlkeCwgMSwgbmV3Q29sdW1uKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiJdfQ==