import { deprecatedWarning } from '@pebula/ngrid/core';
import { PblMetaColumn } from './meta-column';
import { PblColumn } from './column';
import { PblColumnGroup, PblColumnGroupStore } from './group-column';
export class PblColumnFactory {
    constructor() {
        this._raw = { table: { cols: [] }, header: [], footer: [], headerGroup: [] };
        this._defaults = {
            table: {},
            header: {},
            footer: {},
        };
        this._currentHeaderRow = 0;
        this._currentFooterRow = 0;
    }
    get currentHeaderRow() { return this._currentHeaderRow; }
    get currentFooterRow() { return this._currentFooterRow; }
    static fromDefinitionSet(defs) {
        const f = new PblColumnFactory();
        Object.assign(f._raw, defs);
        return f;
    }
    build() {
        const { _defaults, _raw } = this;
        const groupStore = new PblColumnGroupStore();
        const table = {
            header: _raw.table.header,
            footer: _raw.table.footer,
            cols: _raw.table.cols.map(d => new PblColumn({ ..._defaults.table, ...d }, groupStore)),
        };
        const header = _raw.header.map(h => ({
            rowIndex: h.rowIndex,
            rowClassName: h.rowClassName,
            type: h.type || 'fixed',
            cols: h.cols.map(c => new PblMetaColumn({ ..._defaults.header, ...c })),
        }));
        const footer = _raw.footer.map(f => ({
            rowIndex: f.rowIndex,
            rowClassName: f.rowClassName,
            type: f.type || 'fixed',
            cols: f.cols.map(c => new PblMetaColumn({ ..._defaults.footer, ...c }))
        }));
        const headerGroup = _raw.headerGroup.map(hg => ({
            rowIndex: hg.rowIndex,
            rowClassName: hg.rowClassName,
            type: hg.type || 'fixed',
            cols: this.buildHeaderGroups(hg.rowIndex, hg.cols, table.cols).map(g => {
                groupStore.add(g);
                return g;
            }),
        }));
        return {
            groupStore,
            table,
            header,
            footer,
            headerGroup,
        };
    }
    default(def, type = 'table') {
        this._defaults[type] = def;
        return this;
    }
    table(...defs) {
        const rowOptions = defs[0].prop ? {} : defs.shift();
        const { header, footer } = rowOptions;
        Object.assign(this._raw.table, { header, footer });
        this._raw.table.cols.push(...defs);
        return this;
    }
    header(...defs) {
        const rowIndex = this._currentHeaderRow++;
        const rowOptions = this.processRowOptions(defs);
        const rowClassName = this.genRowClass(rowOptions, rowIndex);
        const headers = defs.map((d) => {
            const def = {
                id: d.id,
                kind: 'header',
                rowIndex
            };
            return Object.assign(def, d);
        });
        this._raw.header.push({
            rowIndex,
            rowClassName,
            cols: headers,
            type: (rowOptions && rowOptions.type) || 'fixed',
        });
        return this;
    }
    footer(...defs) {
        const rowIndex = this._currentFooterRow++;
        const rowOptions = this.processRowOptions(defs);
        const rowClassName = this.genRowClass(rowOptions, rowIndex);
        const footers = defs.map((d) => {
            const def = {
                id: d.id,
                kind: 'footer',
                rowIndex
            };
            return Object.assign(def, d);
        });
        this._raw.footer.push({
            rowIndex,
            rowClassName,
            cols: footers,
            type: (rowOptions && rowOptions.type) || 'fixed',
        });
        return this;
    }
    headerGroup(...defs) {
        const rowIndex = this._currentHeaderRow++;
        const rowOptions = this.processRowOptions(defs, 'columnIds', 'prop');
        const rowClassName = this.genRowClass(rowOptions, rowIndex);
        const headerGroups = defs.map(d => Object.assign({ rowIndex }, d));
        this._raw.headerGroup.push({
            rowIndex,
            rowClassName,
            cols: headerGroups,
            type: (rowOptions && rowOptions.type) || 'fixed',
        });
        return this;
    }
    processRowOptions(defs, ...mustHaveProperty) {
        if (mustHaveProperty.length === 0) {
            mustHaveProperty = ['id'];
        }
        for (const prop of mustHaveProperty) {
            if (prop in defs[0]) {
                return;
            }
        }
        return defs.shift();
    }
    genRowClass(rowOptions, fallbackRowIndex) {
        return (rowOptions && rowOptions.rowClassName) || `pbl-ngrid-row-index-${fallbackRowIndex.toString()}`;
    }
    buildHeaderGroups(rowIndex, headerGroupDefs, table) {
        const headerGroup = [];
        // Building of header group rows requires some work.
        // The user defined groups might not cover all columns, creating gaps between group columns so we need to add placeholder groups to cover these gaps.
        // Moreover, the user might not specify a `prop`, which we might need to complete.
        // We do that for each header group row.
        //
        // The end goal is to return a list of `PblColumnGroup` that span over the entire columns of the grid.
        //
        // The logic is as follows:
        // For each column in the grid, find a matching column group - a group pointing at the column by having the same `prop`
        // If found, check it's span and skip X amount of columns where X is the span.
        // If a span is not defined then treat it as a greedy group that spans over all columns ahead until the next column that has a matching group column.
        //
        // If a column does not have a matching group column, search for group columns without a `prop` specified and when found set their `prop` to the current
        // column so we will now use them as if it's a user provided group for this column...
        //
        // If no group columns exists (or left), we create an ad-hoc group column and we will now use them as if it's a user provided group for this column...
        //
        const tableDefs = table.slice();
        const defs = headerGroupDefs.slice();
        for (const d of defs) {
            // TODO: remove in V5, when prop & span are deprecated
            // @deprecated Will be removed in v5
            if (d.prop) {
                if (typeof ngDevMode === 'undefined' || ngDevMode) {
                    deprecatedWarning('PblColumnGroupDefinition.prop', '4', 'PblColumnGroupDefinition.columnIds');
                    deprecatedWarning('PblColumnGroupDefinition.span', '4', 'PblColumnGroupDefinition.columnIds');
                }
                const start = tableDefs.findIndex(c => c.orgProp === d.prop);
                d.columnIds = tableDefs.slice(start, start + d.span + 1).map(c => c.id);
                delete d.prop;
                delete d.span;
            }
            d.rowIndex = rowIndex;
            const group = new PblColumnGroup(d, tableDefs.filter(c => d.columnIds.indexOf(c.orgProp) > -1), false);
            headerGroup.push(group);
        }
        let marker = 0;
        while (tableDefs.length) {
            const column = tableDefs.shift();
            const orgProp = column.orgProp;
            const existingGroupIndex = headerGroup.findIndex(hg => hg.columnIds.indexOf(orgProp) > -1);
            if (existingGroupIndex > -1) {
                const hg = headerGroup[existingGroupIndex];
                if (existingGroupIndex < marker) {
                    const columns = [column];
                    while (hg.columnIds.indexOf(tableDefs[0]?.orgProp) > -1) {
                        columns.push(tableDefs.shift());
                    }
                    headerGroup[marker] = hg.createSlave(columns);
                    marker += 1;
                }
                else {
                    while (hg.columnIds.indexOf(tableDefs[0]?.orgProp) > -1) {
                        tableDefs.shift();
                    }
                    marker += 1;
                }
            }
            else {
                const prev = headerGroup[marker - 1];
                if (prev?.placeholder) {
                    const clone = Object.keys(prev).reduce((p, c) => {
                        p[c] = prev[c];
                        return p;
                    }, {});
                    clone.columnIds = [...clone.columnIds, orgProp];
                    delete clone.id;
                    headerGroup[marker - 1] = new PblColumnGroup(clone, [...prev.columns, column], true);
                }
                else {
                    const d = { rowIndex, kind: 'header', columnIds: [orgProp] };
                    headerGroup.splice(marker, 0, new PblColumnGroup(d, [column], true));
                    marker += 1;
                }
            }
        }
        return headerGroup;
    }
}
export function columnFactory() {
    return new PblColumnFactory();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmdyaWQvc3JjL2xpYi9ncmlkL2NvbHVtbi9tb2RlbC9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFPTCxpQkFBaUIsRUFDbEIsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXJFLE1BQU0sT0FBTyxnQkFBZ0I7SUFBN0I7UUFDVSxTQUFJLEdBQWdDLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDckcsY0FBUyxHQUFHO1lBQ2xCLEtBQUssRUFBRSxFQUFrQztZQUN6QyxNQUFNLEVBQUUsRUFBc0M7WUFDOUMsTUFBTSxFQUFFLEVBQXNDO1NBQy9DLENBQUM7UUFFTSxzQkFBaUIsR0FBRyxDQUFDLENBQUM7UUFDdEIsc0JBQWlCLEdBQUcsQ0FBQyxDQUFDO0lBNlRoQyxDQUFDO0lBM1RDLElBQUksZ0JBQWdCLEtBQWEsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLElBQUksZ0JBQWdCLEtBQWEsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO0lBRWpFLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFpQztRQUN4RCxNQUFNLENBQUMsR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUM7UUFDakMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElB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O0NBQ0Y7QUFFRCxNQUFNLFVBQVUsYUFBYTtJQUMzQixPQUFPLElBQUksZ0JBQWdCLEVBQUUsQ0FBQTtBQUMvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgUGJsQmFzZUNvbHVtbkRlZmluaXRpb24sXG4gIFBibENvbHVtbkRlZmluaXRpb24sXG4gIFBibENvbHVtbkdyb3VwRGVmaW5pdGlvbixcbiAgUGJsTWV0YUNvbHVtbkRlZmluaXRpb24sXG4gIFBibE5ncmlkQ29sdW1uRGVmaW5pdGlvblNldCxcbiAgUGJsTWV0YVJvd0RlZmluaXRpb25zLFxuICBkZXByZWNhdGVkV2FybmluZ1xufSBmcm9tICdAcGVidWxhL25ncmlkL2NvcmUnO1xuaW1wb3J0IHsgUGJsTmdyaWRDb2x1bW5TZXQgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IFBibE1ldGFDb2x1bW4gfSBmcm9tICcuL21ldGEtY29sdW1uJztcbmltcG9ydCB7IFBibENvbHVtbiB9IGZyb20gJy4vY29sdW1uJztcbmltcG9ydCB7IFBibENvbHVtbkdyb3VwLCBQYmxDb2x1bW5Hcm91cFN0b3JlIH0gZnJvbSAnLi9ncm91cC1jb2x1bW4nO1xuXG5leHBvcnQgdHlwZSBDT0xVTU4gPSBQYmxNZXRhQ29sdW1uIHwgUGJsQ29sdW1uIHwgUGJsQ29sdW1uR3JvdXA7XG5cbmV4cG9ydCBjbGFzcyBQYmxDb2x1bW5GYWN0b3J5IHtcbiAgcHJpdmF0ZSBfcmF3OiBQYmxOZ3JpZENvbHVtbkRlZmluaXRpb25TZXQgPSB7IHRhYmxlOiB7IGNvbHM6IFtdIH0sIGhlYWRlcjogW10sIGZvb3RlcjogW10sIGhlYWRlckdyb3VwOiBbXSB9O1xuICBwcml2YXRlIF9kZWZhdWx0cyA9IHtcbiAgICB0YWJsZToge30gYXMgUGFydGlhbDxQYmxDb2x1bW5EZWZpbml0aW9uPixcbiAgICBoZWFkZXI6IHt9IGFzIFBhcnRpYWw8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24+LFxuICAgIGZvb3Rlcjoge30gYXMgUGFydGlhbDxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbj4sXG4gIH07XG5cbiAgcHJpdmF0ZSBfY3VycmVudEhlYWRlclJvdyA9IDA7XG4gIHByaXZhdGUgX2N1cnJlbnRGb290ZXJSb3cgPSAwO1xuXG4gIGdldCBjdXJyZW50SGVhZGVyUm93KCk6IG51bWJlciB7IHJldHVybiB0aGlzLl9jdXJyZW50SGVhZGVyUm93OyB9XG4gIGdldCBjdXJyZW50Rm9vdGVyUm93KCk6IG51bWJlciB7IHJldHVybiB0aGlzLl9jdXJyZW50Rm9vdGVyUm93OyB9XG5cbiAgc3RhdGljIGZyb21EZWZpbml0aW9uU2V0KGRlZnM6IFBibE5ncmlkQ29sdW1uRGVmaW5pdGlvblNldCk6IFBibENvbHVtbkZhY3Rvcnkge1xuICAgIGNvbnN0IGYgPSBuZXcgUGJsQ29sdW1uRmFjdG9yeSgpO1xuICAgIE9iamVjdC5hc3NpZ24oZi5fcmF3LCBkZWZzKTtcbiAgICByZXR1cm4gZjtcbiAgfVxuXG4gIGJ1aWxkKCk6IFBibE5ncmlkQ29sdW1uU2V0IHtcbiAgICBjb25zdCB7IF9kZWZhdWx0cywgX3JhdyB9ID0gdGhpcztcblxuICAgIGNvbnN0IGdyb3VwU3RvcmUgPSBuZXcgUGJsQ29sdW1uR3JvdXBTdG9yZSgpO1xuXG4gICAgY29uc3QgdGFibGU6IFBibE5ncmlkQ29sdW1uU2V0Wyd0YWJsZSddID0ge1xuICAgICAgaGVhZGVyOiBfcmF3LnRhYmxlLmhlYWRlcixcbiAgICAgIGZvb3RlcjogX3Jhdy50YWJsZS5mb290ZXIsXG4gICAgICBjb2xzOiBfcmF3LnRhYmxlLmNvbHMubWFwKCBkID0+IG5ldyBQYmxDb2x1bW4oeyAuLi5fZGVmYXVsdHMudGFibGUsIC4uLmQgfSwgZ3JvdXBTdG9yZSkpLFxuICAgIH07XG4gICAgY29uc3QgaGVhZGVyID0gX3Jhdy5oZWFkZXIubWFwKCBoID0+ICh7XG4gICAgICByb3dJbmRleDogaC5yb3dJbmRleCxcbiAgICAgIHJvd0NsYXNzTmFtZTogaC5yb3dDbGFzc05hbWUsXG4gICAgICB0eXBlOiBoLnR5cGUgfHwgJ2ZpeGVkJyxcbiAgICAgIGNvbHM6IGguY29scy5tYXAoIGMgPT4gbmV3IFBibE1ldGFDb2x1bW4oIHsgLi4uX2RlZmF1bHRzLmhlYWRlciwgLi4uYyB9ICkpLFxuICAgIH0pKTtcbiAgICBjb25zdCBmb290ZXIgPSBfcmF3LmZvb3Rlci5tYXAoIGYgPT4gKHtcbiAgICAgIHJvd0luZGV4OiBmLnJvd0luZGV4LFxuICAgICAgcm93Q2xhc3NOYW1lOiBmLnJvd0NsYXNzTmFtZSxcbiAgICAgIHR5cGU6IGYudHlwZSB8fCAnZml4ZWQnLFxuICAgICAgY29sczogZi5jb2xzLm1hcCggYyA9PiBuZXcgUGJsTWV0YUNvbHVtbih7IC4uLl9kZWZhdWx0cy5mb290ZXIsIC4uLmMgfSkgKVxuICAgIH0pKTtcbiAgICBjb25zdCBoZWFkZXJHcm91cCA9IF9yYXcuaGVhZGVyR3JvdXAubWFwKCBoZyA9PiAoe1xuICAgICAgcm93SW5kZXg6IGhnLnJvd0luZGV4LFxuICAgICAgcm93Q2xhc3NOYW1lOiBoZy5yb3dDbGFzc05hbWUsXG4gICAgICB0eXBlOiBoZy50eXBlIHx8ICdmaXhlZCcsXG4gICAgICBjb2xzOiB0aGlzLmJ1aWxkSGVhZGVyR3JvdXBzKGhnLnJvd0luZGV4LCBoZy5jb2xzLCB0YWJsZS5jb2xzKS5tYXAoIGcgPT4ge1xuICAgICAgICBncm91cFN0b3JlLmFkZChnKTtcbiAgICAgICAgcmV0dXJuIGc7XG4gICAgICB9KSxcbiAgICB9KSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZ3JvdXBTdG9yZSxcbiAgICAgIHRhYmxlLFxuICAgICAgaGVhZGVyLFxuICAgICAgZm9vdGVyLFxuICAgICAgaGVhZGVyR3JvdXAsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGRlZmF1bHQgY29sdW1uIGRlZmluaXRpb24gZm9yIGhlYWRlci9mb290ZXIgY29sdW1ucy5cbiAgICovXG4gIGRlZmF1bHQoZGVmOiBQYXJ0aWFsPFBibE1ldGFDb2x1bW5EZWZpbml0aW9uPiwgdHlwZTogJ2hlYWRlcicgfCAnZm9vdGVyJyk6IHRoaXM7XG4gIC8qKlxuICAgKiBTZXQgdGhlIGRlZmF1bHQgY29sdW1uIGRlZmluaXRpb24gZm9yIHRhYmxlIGNvbHVtbnMuXG4gICAqL1xuICBkZWZhdWx0KGRlZjogUGFydGlhbDxQYmxDb2x1bW5EZWZpbml0aW9uPiwgdHlwZT86ICd0YWJsZScpOiB0aGlzO1xuICBkZWZhdWx0KGRlZjogUGFydGlhbDxQYmxDb2x1bW5EZWZpbml0aW9uPiB8IFBhcnRpYWw8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24+LCB0eXBlOiAndGFibGUnIHwgJ2hlYWRlcicgfCAnZm9vdGVyJyA9ICd0YWJsZScpOiB0aGlzIHtcbiAgICB0aGlzLl9kZWZhdWx0c1t0eXBlXSA9IGRlZjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgZ3JpZCBjb2x1bW5zLlxuICAgKlxuICAgKiBUYWJsZSBjb2x1bW5zIGFyZSBtYW5kYXRvcnksIHRoZXkgYXJlIHRoZSBjb2x1bW5zIHRoYXQgZGVmaW5lIHRoZSBzdHJ1Y3R1cmUgb2YgdGhlIGRhdGEgc291cmNlLlxuICAgKlxuICAgKiBFYWNoIGNvbHVtbiB3aWxsIHVzdWFsbHkgcG9pbnQgdG8gcHJvcGVydHkgb24gdGhlIHJvdywgYWx0aG91Z2ggeW91IGNhbiBjcmVhdGUgY29sdW1ucyB0aGF0IGRvZXMgbm90XG4gICAqIGV4aXN0IG9uIHRoZSByb3cgYW5kIGhhbmRsZSB0aGVpciByZW5kZXJpbmcgd2l0aCBhIGNlbGwgdGVtcGxhdGUuXG4gICAqXG4gICAqIEVhY2ggZ3JpZCBjb2x1bW4gaXMgYWxzbyBhIGhlYWRlciBjb2x1bW4gYW5kIGEgZm9vdGVyIGNvbHVtbiB0aGF0IGRpc3BsYXkuXG4gICAqIFRoZSBoZWFkZXIgYW5kIGZvb3RlciBhcmUgYXV0b21hdGljYWxseSBjcmVhdGVkLCBJZiB5b3Ugd2lzaCBub3QgdG8gc2hvdyB0aGVtIHNldCBoZWFkZXJSb3cvZm9vdGVyUm93IHRvIGZhbHNlIGluIFBibFRhYmxlLlxuICAgKlxuICAgKi9cbiAgdGFibGUocm93T3B0aW9uczogeyBoZWFkZXI/OiBQYmxNZXRhUm93RGVmaW5pdGlvbnM7IGZvb3Rlcj86IFBibE1ldGFSb3dEZWZpbml0aW9ucyB9LCAuLi5kZWZzOiBQYmxDb2x1bW5EZWZpbml0aW9uW10pOiB0aGlzO1xuICB0YWJsZSguLi5kZWZzOiBQYmxDb2x1bW5EZWZpbml0aW9uW10pOiB0aGlzO1xuICB0YWJsZSguLi5kZWZzOiBBcnJheTx7IGhlYWRlcj86IFBibE1ldGFSb3dEZWZpbml0aW9uczsgZm9vdGVyPzogUGJsTWV0YVJvd0RlZmluaXRpb25zIH0gfCBQYmxDb2x1bW5EZWZpbml0aW9uPik6IHRoaXMge1xuICAgIGNvbnN0IHJvd09wdGlvbnM6IHsgaGVhZGVyPzogUGJsTWV0YVJvd0RlZmluaXRpb25zOyBmb290ZXI/OiBQYmxNZXRhUm93RGVmaW5pdGlvbnMgfSA9IChkZWZzWzBdIGFzIGFueSkucHJvcCA/IHt9IDogZGVmcy5zaGlmdCgpIGFzIGFueTtcbiAgICBjb25zdCB7IGhlYWRlciwgZm9vdGVyIH0gPSByb3dPcHRpb25zO1xuICAgIE9iamVjdC5hc3NpZ24odGhpcy5fcmF3LnRhYmxlLCB7IGhlYWRlciwgZm9vdGVyIH0pO1xuICAgIHRoaXMuX3Jhdy50YWJsZS5jb2xzLnB1c2goLi4uZGVmcyBhcyBQYmxDb2x1bW5EZWZpbml0aW9uW10pO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIG5ldyBoZWFkZXIgcm93IHdpdGggaGVhZGVyIGNvbHVtbnMuXG4gICAqIENyZWF0ZXMgYW4gYWRkaXRpb25hbCBoZWFkZXIgcm93IGluIHBvc2l0aW9uIGBjdXJyZW50SGVhZGVyUm93YCB1c2luZyB0aGUgcHJvdmlkZWQgaGVhZGVyIGNvbHVtbiBkZWZpbml0aW9ucy5cbiAgICogRWFjaCBkZWZpbml0aW9uIHJlcHJlc2VudCBhIGNlbGwsIHRoZSBjZWxsJ3MgZG9lcyBub3QgaGF2ZSB0byBhbGlnbiB3aXRoIHRoZSBsYXlvdXQgb2YgZ3JpZCBjb2x1bW5zLlxuICAgKlxuICAgKiBBbGwgaGVhZGVyIHJvdyB3aWxsIHBvc2l0aW9uIEJFRk9SRSB0aGUgZ3JpZCBjb2x1bW4gaGVhZGVyIHJvdy5cbiAgICogSGVhZGVyIGNvbHVtbnMgYXJlIG9wdGlvbmFsLlxuICAgKiBFYWNoIGNhbGwgdG8gYGhlYWRlcigpYCB3aWxsIGNyZWF0ZSBhIG5ldyByb3csIGluY3JlbWVudGluZyB0aGUgYGN1cnJlbnRIZWFkZXJSb3dgLlxuICAgKlxuICAgKiBAcmVtYXJrc1xuICAgKiBFeGFtcGxlOlxuICAgKiBgYGBqc1xuICAgKiAgIGZhY3RvcnkudGFibGUoMSwgMiwgMylcbiAgICogICAgIC5oZWFkZXIoYSwgYiwgYykuaGVhZGVyKGQsIGUsIGYpO1xuICAgKiBgYGBcbiAgICpcbiAgICogd2lsbCByZXN1bHQgaW46XG4gICAqICAgaGVhZGVyMSAtXFw+ICBhIGIgY1xuICAgKiAgIGhlYWRlcjIgLVxcPiAgZCBlIGZcbiAgICogICB0YWJsZSAgIC1cXD4gIDEgMiAzXG4gICAqL1xuICBoZWFkZXIocm93T3B0aW9uczogUGJsTWV0YVJvd0RlZmluaXRpb25zLCAuLi5kZWZzOiBBcnJheTxQaWNrPFBibE1ldGFDb2x1bW5EZWZpbml0aW9uLCAnaWQnPiAmIFBhcnRpYWw8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24+ICYgUGJsQmFzZUNvbHVtbkRlZmluaXRpb24+KTogdGhpcztcbiAgaGVhZGVyKC4uLmRlZnM6IEFycmF5PFBpY2s8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24sICdpZCc+ICYgUGFydGlhbDxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbj4gJiBQYmxCYXNlQ29sdW1uRGVmaW5pdGlvbj4pOiB0aGlzO1xuICBoZWFkZXIoLi4uZGVmczogQXJyYXk8UGJsTWV0YVJvd0RlZmluaXRpb25zIHwgUGljazxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbiwgJ2lkJz4gJiBQYXJ0aWFsPFBibE1ldGFDb2x1bW5EZWZpbml0aW9uPiAmIFBibEJhc2VDb2x1bW5EZWZpbml0aW9uPik6IHRoaXMge1xuICAgIGNvbnN0IHJvd0luZGV4ID0gdGhpcy5fY3VycmVudEhlYWRlclJvdysrO1xuICAgIGNvbnN0IHJvd09wdGlvbnMgPSB0aGlzLnByb2Nlc3NSb3dPcHRpb25zKGRlZnMpO1xuICAgIGNvbnN0IHJvd0NsYXNzTmFtZSA9IHRoaXMuZ2VuUm93Q2xhc3Mocm93T3B0aW9ucywgcm93SW5kZXgpO1xuXG4gICAgY29uc3QgaGVhZGVycyA9IGRlZnMubWFwKCAoZDogUGljazxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbiwgJ2lkJz4gJiBQYXJ0aWFsPFBibE1ldGFDb2x1bW5EZWZpbml0aW9uPiAmIFBibEJhc2VDb2x1bW5EZWZpbml0aW9uKSA9PiB7XG4gICAgICBjb25zdCBkZWY6IFBibE1ldGFDb2x1bW5EZWZpbml0aW9uID0ge1xuICAgICAgICBpZDogZC5pZCxcbiAgICAgICAga2luZDogJ2hlYWRlcicsXG4gICAgICAgIHJvd0luZGV4XG4gICAgICB9O1xuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oZGVmLCBkKTtcbiAgICB9KTtcblxuICAgIHRoaXMuX3Jhdy5oZWFkZXIucHVzaCh7XG4gICAgICByb3dJbmRleCxcbiAgICAgIHJvd0NsYXNzTmFtZSxcbiAgICAgIGNvbHM6IGhlYWRlcnMsXG4gICAgICB0eXBlOiAocm93T3B0aW9ucyAmJiByb3dPcHRpb25zLnR5cGUpIHx8ICdmaXhlZCcsXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgbmV3IGZvb3RlciByb3cgd2l0aCBmb290ZXIgY29sdW1ucy5cbiAgICogQ3JlYXRlcyBhbiBhZGRpdGlvbmFsIGZvb3RlciByb3cgaW4gcG9zaXRpb24gYGN1cnJlbnRGb290ZXJSb3dgIHVzaW5nIHRoZSBwcm92aWRlZCBmb290ZXIgY29sdW1uIGRlZmluaXRpb25zLlxuICAgKiBFYWNoIGRlZmluaXRpb24gcmVwcmVzZW50IGEgY2VsbCwgdGhlIGNlbGwncyBkb2VzIG5vdCBoYXZlIHRvIGFsaWduIHdpdGggdGhlIGxheW91dCBvZiBncmlkIGNvbHVtbnMuXG4gICAqXG4gICAqIEFsbCBmb290ZXIgcm93IHdpbGwgcG9zaXRpb24gQUZURVIgdGhlIGdyaWQgY29sdW1uIGZvb3RlciByb3cuXG4gICAqIEZvb3RlciBjb2x1bW5zIGFyZSBvcHRpb25hbC5cbiAgICogRWFjaCBjYWxsIHRvIGBmb290ZXIoKWAgd2lsbCBjcmVhdGUgYSBuZXcgcm93LCBpbmNyZW1lbnRpbmcgdGhlIGBjdXJyZW50Rm9vdGVyUm93YC5cbiAgICpcbiAgICogQHJlbWFya3NcbiAgICogRXhhbXBsZTpcbiAgICogYGBganNcbiAgICogICBmYWN0b3J5LnRhYmxlKDEsIDIsIDMpXG4gICAqICAgICAuZm9vdGVyKGEsIGIsIGMpLmZvb3RlcihkLCBlLCBmKTtcbiAgICogYGBgXG4gICAqXG4gICAqIHdpbGwgcmVzdWx0IGluOlxuICAgKiAgIHRhYmxlICAgLVxcPiAgMSAyIDNcbiAgICogICBmb290ZXIxIC1cXD4gIGEgYiBjXG4gICAqICAgZm9vdGVyMiAtXFw+ICBkIGUgZlxuICAgKi9cbiAgZm9vdGVyKHJvd09wdGlvbnM6IFBibE1ldGFSb3dEZWZpbml0aW9ucywgLi4uZGVmczogQXJyYXk8UGljazxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbiwgJ2lkJz4gJiBQYXJ0aWFsPFBibE1ldGFDb2x1bW5EZWZpbml0aW9uPiAmIFBibEJhc2VDb2x1bW5EZWZpbml0aW9uPik6IHRoaXM7XG4gIGZvb3RlciguLi5kZWZzOiBBcnJheTxQaWNrPFBibE1ldGFDb2x1bW5EZWZpbml0aW9uLCAnaWQnPiAmIFBhcnRpYWw8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24+ICYgUGJsQmFzZUNvbHVtbkRlZmluaXRpb24+KTogdGhpcztcbiAgZm9vdGVyKC4uLmRlZnM6IEFycmF5PFBibE1ldGFSb3dEZWZpbml0aW9ucyB8IFBpY2s8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24sICdpZCc+ICYgUGFydGlhbDxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbj4gJiBQYmxCYXNlQ29sdW1uRGVmaW5pdGlvbj4pOiB0aGlzIHtcbiAgICBjb25zdCByb3dJbmRleCA9IHRoaXMuX2N1cnJlbnRGb290ZXJSb3crKztcbiAgICBjb25zdCByb3dPcHRpb25zID0gdGhpcy5wcm9jZXNzUm93T3B0aW9ucyhkZWZzKTtcbiAgICBjb25zdCByb3dDbGFzc05hbWUgPSB0aGlzLmdlblJvd0NsYXNzKHJvd09wdGlvbnMsIHJvd0luZGV4KTtcblxuICAgIGNvbnN0IGZvb3RlcnMgPSBkZWZzLm1hcCggKGQ6IFBpY2s8UGJsTWV0YUNvbHVtbkRlZmluaXRpb24sICdpZCc+ICYgUGFydGlhbDxQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbj4gJiBQYmxCYXNlQ29sdW1uRGVmaW5pdGlvbikgPT4ge1xuICAgICAgY29uc3QgZGVmOiBQYmxNZXRhQ29sdW1uRGVmaW5pdGlvbiA9IHtcbiAgICAgICAgaWQ6IGQuaWQsXG4gICAgICAgIGtpbmQ6ICdmb290ZXInLFxuICAgICAgICByb3dJbmRleFxuICAgICAgfTtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKGRlZiwgZCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9yYXcuZm9vdGVyLnB1c2goe1xuICAgICAgcm93SW5kZXgsXG4gICAgICByb3dDbGFzc05hbWUsXG4gICAgICBjb2xzOiBmb290ZXJzLFxuICAgICAgdHlwZTogKHJvd09wdGlvbnMgJiYgcm93T3B0aW9ucy50eXBlKSB8fCAnZml4ZWQnLFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIG5ldyBoZWFkZXIgcm93IHdpdGggaGVhZGVyIGdyb3VwIGNvbHVtbnMuXG4gICAqIEEgaGVhZGVyIGdyb3VwIGNvbHVtbiBpcyBhIGNvbHVtbnMgaXMgYSBoZWFkZXIgY29sdW1ucyB0aGF0IHNwYW5zIG9uZSBvciBtb3JlIGNvbHVtbnMuXG4gICAqXG4gICAqIENyZWF0ZSBhbiBhZGRpdGlvbmFsIGhlYWRlciByb3cgaW4gcG9zaXRpb24gYGN1cnJlbnRIZWFkZXJSb3dgIHVzaW5nIHRoZSBwcm92aWRlZCBoZWFkZXIgY29sdW1uIGRlZmluaXRpb25zLlxuICAgKiBFYWNoIGRlZmluaXRpb24gcmVwcmVzZW50IGEgY2VsbCwgdGhlIGNlbGwncyBkb2VzIG5vdCBoYXZlIHRvIGFsaWduIHdpdGggdGhlIGxheW91dCBvZiBncmlkIGNvbHVtbnMuXG4gICAqXG4gICAqIEFsbCBoZWFkZXIgcm93IHdpbGwgcG9zaXRpb24gQkVGT1JFIHRoZSBncmlkIGNvbHVtbiBoZWFkZXIgcm93LlxuICAgKiBIZWFkZXIgY29sdW1ucyBhcmUgb3B0aW9uYWwuXG4gICAqIEVhY2ggY2FsbCB0byBgaGVhZGVyKClgIHdpbGwgY3JlYXRlIGEgbmV3IHJvdywgaW5jcmVtZW50aW5nIHRoZSBgY3VycmVudEhlYWRlclJvd2AuXG4gICAqXG4gICAqIEByZW1hcmtzXG4gICAqIEV4YW1wbGU6XG4gICAqIGBgYGpzXG4gICAqICAgZmFjdG9yeS50YWJsZSgxLCAyLCAzKVxuICAgKiAgICAgLmhlYWRlcihhLCBiLCBjKS5oZWFkZXIoZCwgZSwgZik7XG4gICAqIGBgYFxuICAgKlxuICAgKiB3aWxsIHJlc3VsdCBpbjpcbiAgICogICBoZWFkZXIxIC1cXD4gIGEgYiBjXG4gICAqICAgaGVhZGVyMiAtXFw+ICBkIGUgZlxuICAgKiAgIHRhYmxlICAgLVxcPiAgMSAyIDNcbiAgICovXG4gIGhlYWRlckdyb3VwKHJvd09wdGlvbnM6IFBibE1ldGFSb3dEZWZpbml0aW9ucywgLi4uZGVmczogQXJyYXk8UGFydGlhbDxPbWl0PFBibENvbHVtbkdyb3VwRGVmaW5pdGlvbiwgJ3Jvd0luZGV4JyB8ICdraW5kJz4+Pik6IHRoaXM7XG4gIGhlYWRlckdyb3VwKC4uLmRlZnM6IEFycmF5PFBhcnRpYWw8T21pdDxQYmxDb2x1bW5Hcm91cERlZmluaXRpb24sICdyb3dJbmRleCcgfCAna2luZCc+Pj4pOiB0aGlzO1xuICBoZWFkZXJHcm91cCguLi5kZWZzOiBBcnJheTxQYmxNZXRhUm93RGVmaW5pdGlvbnMgfCAoIFBhcnRpYWw8T21pdDxQYmxDb2x1bW5Hcm91cERlZmluaXRpb24sICdyb3dJbmRleCcgfCAna2luZCc+PiApID4pOiB0aGlzIHtcbiAgICBjb25zdCByb3dJbmRleCA9IHRoaXMuX2N1cnJlbnRIZWFkZXJSb3crKztcbiAgICBjb25zdCByb3dPcHRpb25zID0gdGhpcy5wcm9jZXNzUm93T3B0aW9ucyhkZWZzLCAnY29sdW1uSWRzJywgJ3Byb3AnKTtcbiAgICBjb25zdCByb3dDbGFzc05hbWUgPSB0aGlzLmdlblJvd0NsYXNzKHJvd09wdGlvbnMsIHJvd0luZGV4KTtcblxuICAgIGNvbnN0IGhlYWRlckdyb3VwczogYW55ID0gZGVmcy5tYXAoIGQgPT4gT2JqZWN0LmFzc2lnbih7IHJvd0luZGV4IH0sIGQpICk7XG5cbiAgICB0aGlzLl9yYXcuaGVhZGVyR3JvdXAucHVzaCh7XG4gICAgICByb3dJbmRleCxcbiAgICAgIHJvd0NsYXNzTmFtZSxcbiAgICAgIGNvbHM6IGhlYWRlckdyb3VwcyxcbiAgICAgIHR5cGU6IChyb3dPcHRpb25zICYmIHJvd09wdGlvbnMudHlwZSkgfHwgJ2ZpeGVkJyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzUm93T3B0aW9ucyhkZWZzOiBhbnlbXSwgLi4ubXVzdEhhdmVQcm9wZXJ0eTogc3RyaW5nW10pOiBQYmxNZXRhUm93RGVmaW5pdGlvbnMge1xuICAgIGlmIChtdXN0SGF2ZVByb3BlcnR5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgbXVzdEhhdmVQcm9wZXJ0eSA9IFsnaWQnXTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBwcm9wIG9mIG11c3RIYXZlUHJvcGVydHkpIHtcbiAgICAgIGlmIChwcm9wIGluIGRlZnNbMF0pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZGVmcy5zaGlmdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5Sb3dDbGFzcyhyb3dPcHRpb25zOiB7IHJvd0NsYXNzTmFtZT86IHN0cmluZyB9LCBmYWxsYmFja1Jvd0luZGV4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiAocm93T3B0aW9ucyAmJiByb3dPcHRpb25zLnJvd0NsYXNzTmFtZSkgfHwgYHBibC1uZ3JpZC1yb3ctaW5kZXgtJHtmYWxsYmFja1Jvd0luZGV4LnRvU3RyaW5nKCl9YDtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRIZWFkZXJHcm91cHMocm93SW5kZXg6IG51bWJlciwgaGVhZGVyR3JvdXBEZWZzOiBQYmxDb2x1bW5Hcm91cERlZmluaXRpb25bXSwgdGFibGU6IFBibENvbHVtbltdKTogUGJsQ29sdW1uR3JvdXBbXSB7XG4gICAgY29uc3QgaGVhZGVyR3JvdXA6IFBibENvbHVtbkdyb3VwW10gPSBbXTtcblxuICAgIC8vIEJ1aWxkaW5nIG9mIGhlYWRlciBncm91cCByb3dzIHJlcXVpcmVzIHNvbWUgd29yay5cbiAgICAvLyBUaGUgdXNlciBkZWZpbmVkIGdyb3VwcyBtaWdodCBub3QgY292ZXIgYWxsIGNvbHVtbnMsIGNyZWF0aW5nIGdhcHMgYmV0d2VlbiBncm91cCBjb2x1bW5zIHNvIHdlIG5lZWQgdG8gYWRkIHBsYWNlaG9sZGVyIGdyb3VwcyB0byBjb3ZlciB0aGVzZSBnYXBzLlxuICAgIC8vIE1vcmVvdmVyLCB0aGUgdXNlciBtaWdodCBub3Qgc3BlY2lmeSBhIGBwcm9wYCwgd2hpY2ggd2UgbWlnaHQgbmVlZCB0byBjb21wbGV0ZS5cbiAgICAvLyBXZSBkbyB0aGF0IGZvciBlYWNoIGhlYWRlciBncm91cCByb3cuXG4gICAgLy9cbiAgICAvLyBUaGUgZW5kIGdvYWwgaXMgdG8gcmV0dXJuIGEgbGlzdCBvZiBgUGJsQ29sdW1uR3JvdXBgIHRoYXQgc3BhbiBvdmVyIHRoZSBlbnRpcmUgY29sdW1ucyBvZiB0aGUgZ3JpZC5cbiAgICAvL1xuICAgIC8vIFRoZSBsb2dpYyBpcyBhcyBmb2xsb3dzOlxuICAgIC8vIEZvciBlYWNoIGNvbHVtbiBpbiB0aGUgZ3JpZCwgZmluZCBhIG1hdGNoaW5nIGNvbHVtbiBncm91cCAtIGEgZ3JvdXAgcG9pbnRpbmcgYXQgdGhlIGNvbHVtbiBieSBoYXZpbmcgdGhlIHNhbWUgYHByb3BgXG4gICAgLy8gSWYgZm91bmQsIGNoZWNrIGl0J3Mgc3BhbiBhbmQgc2tpcCBYIGFtb3VudCBvZiBjb2x1bW5zIHdoZXJlIFggaXMgdGhlIHNwYW4uXG4gICAgLy8gSWYgYSBzcGFuIGlzIG5vdCBkZWZpbmVkIHRoZW4gdHJlYXQgaXQgYXMgYSBncmVlZHkgZ3JvdXAgdGhhdCBzcGFucyBvdmVyIGFsbCBjb2x1bW5zIGFoZWFkIHVudGlsIHRoZSBuZXh0IGNvbHVtbiB0aGF0IGhhcyBhIG1hdGNoaW5nIGdyb3VwIGNvbHVtbi5cbiAgICAvL1xuICAgIC8vIElmIGEgY29sdW1uIGRvZXMgbm90IGhhdmUgYSBtYXRjaGluZyBncm91cCBjb2x1bW4sIHNlYXJjaCBmb3IgZ3JvdXAgY29sdW1ucyB3aXRob3V0IGEgYHByb3BgIHNwZWNpZmllZCBhbmQgd2hlbiBmb3VuZCBzZXQgdGhlaXIgYHByb3BgIHRvIHRoZSBjdXJyZW50XG4gICAgLy8gY29sdW1uIHNvIHdlIHdpbGwgbm93IHVzZSB0aGVtIGFzIGlmIGl0J3MgYSB1c2VyIHByb3ZpZGVkIGdyb3VwIGZvciB0aGlzIGNvbHVtbi4uLlxuICAgIC8vXG4gICAgLy8gSWYgbm8gZ3JvdXAgY29sdW1ucyBleGlzdHMgKG9yIGxlZnQpLCB3ZSBjcmVhdGUgYW4gYWQtaG9jIGdyb3VwIGNvbHVtbiBhbmQgd2Ugd2lsbCBub3cgdXNlIHRoZW0gYXMgaWYgaXQncyBhIHVzZXIgcHJvdmlkZWQgZ3JvdXAgZm9yIHRoaXMgY29sdW1uLi4uXG4gICAgLy9cbiAgICBjb25zdCB0YWJsZURlZnMgPSB0YWJsZS5zbGljZSgpO1xuICAgIGNvbnN0IGRlZnMgPSBoZWFkZXJHcm91cERlZnMuc2xpY2UoKTtcblxuICAgIGZvciAoY29uc3QgZCBvZiBkZWZzKSB7XG4gICAgICAvLyBUT0RPOiByZW1vdmUgaW4gVjUsIHdoZW4gcHJvcCAmIHNwYW4gYXJlIGRlcHJlY2F0ZWRcbiAgICAgIC8vIEBkZXByZWNhdGVkIFdpbGwgYmUgcmVtb3ZlZCBpbiB2NVxuICAgICAgaWYgKGQucHJvcCkge1xuICAgICAgICBpZiAodHlwZW9mIG5nRGV2TW9kZSA9PT0gJ3VuZGVmaW5lZCcgfHwgbmdEZXZNb2RlKSB7XG4gICAgICAgICAgZGVwcmVjYXRlZFdhcm5pbmcoJ1BibENvbHVtbkdyb3VwRGVmaW5pdGlvbi5wcm9wJywgJzQnLCAnUGJsQ29sdW1uR3JvdXBEZWZpbml0aW9uLmNvbHVtbklkcycpO1xuICAgICAgICAgIGRlcHJlY2F0ZWRXYXJuaW5nKCdQYmxDb2x1bW5Hcm91cERlZmluaXRpb24uc3BhbicsICc0JywgJ1BibENvbHVtbkdyb3VwRGVmaW5pdGlvbi5jb2x1bW5JZHMnKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdGFydCA9IHRhYmxlRGVmcy5maW5kSW5kZXgoIGMgPT4gYy5vcmdQcm9wID09PSBkLnByb3AgKTtcbiAgICAgICAgZC5jb2x1bW5JZHMgPSB0YWJsZURlZnMuc2xpY2Uoc3RhcnQsIHN0YXJ0ICsgZC5zcGFuICsgMSkubWFwKCBjID0+IGMuaWQgKTtcbiAgICAgICAgZGVsZXRlIGQucHJvcDtcbiAgICAgICAgZGVsZXRlIGQuc3BhbjtcbiAgICAgIH1cbiAgICAgIGQucm93SW5kZXggPSByb3dJbmRleDtcbiAgICAgIGNvbnN0IGdyb3VwID0gbmV3IFBibENvbHVtbkdyb3VwKGQsIHRhYmxlRGVmcy5maWx0ZXIoIGMgPT4gZC5jb2x1bW5JZHMuaW5kZXhPZihjLm9yZ1Byb3ApID4gLTEgKSwgZmFsc2UpO1xuICAgICAgaGVhZGVyR3JvdXAucHVzaChncm91cCk7XG4gICAgfVxuXG4gICAgbGV0IG1hcmtlciA9IDA7XG4gICAgd2hpbGUgKHRhYmxlRGVmcy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGNvbHVtbiA9IHRhYmxlRGVmcy5zaGlmdCgpO1xuICAgICAgY29uc3Qgb3JnUHJvcCA9IGNvbHVtbi5vcmdQcm9wO1xuICAgICAgY29uc3QgZXhpc3RpbmdHcm91cEluZGV4ID0gaGVhZGVyR3JvdXAuZmluZEluZGV4KCBoZyA9PiBoZy5jb2x1bW5JZHMuaW5kZXhPZihvcmdQcm9wKSA+IC0xICk7XG4gICAgICBpZiAoZXhpc3RpbmdHcm91cEluZGV4ID4gLTEpIHtcbiAgICAgICAgY29uc3QgaGcgPSBoZWFkZXJHcm91cFtleGlzdGluZ0dyb3VwSW5kZXhdO1xuICAgICAgICBpZiAoZXhpc3RpbmdHcm91cEluZGV4IDwgbWFya2VyKSB7XG4gICAgICAgICAgY29uc3QgY29sdW1ucyA9IFtjb2x1bW5dO1xuICAgICAgICAgIHdoaWxlIChoZy5jb2x1bW5JZHMuaW5kZXhPZih0YWJsZURlZnNbMF0/Lm9yZ1Byb3ApID4gLTEpIHtcbiAgICAgICAgICAgIGNvbHVtbnMucHVzaCh0YWJsZURlZnMuc2hpZnQoKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGhlYWRlckdyb3VwW21hcmtlcl0gPSBoZy5jcmVhdGVTbGF2ZShjb2x1bW5zKTtcbiAgICAgICAgICBtYXJrZXIgKz0gMTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3aGlsZSAoaGcuY29sdW1uSWRzLmluZGV4T2YodGFibGVEZWZzWzBdPy5vcmdQcm9wKSA+IC0xKSB7XG4gICAgICAgICAgICB0YWJsZURlZnMuc2hpZnQoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbWFya2VyICs9IDE7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHByZXYgPSBoZWFkZXJHcm91cFttYXJrZXIgLSAxXTtcbiAgICAgICAgaWYgKHByZXY/LnBsYWNlaG9sZGVyKSB7XG4gICAgICAgICAgY29uc3QgY2xvbmUgPSBPYmplY3Qua2V5cyhwcmV2KS5yZWR1Y2UoIChwLCBjKSA9PiB7XG4gICAgICAgICAgICBwW2NdID0gcHJldltjXTtcbiAgICAgICAgICAgIHJldHVybiBwO1xuICAgICAgICAgIH0sIHt9IGFzIFBibENvbHVtbkdyb3VwRGVmaW5pdGlvbik7XG4gICAgICAgICAgY2xvbmUuY29sdW1uSWRzID0gWy4uLmNsb25lLmNvbHVtbklkcywgb3JnUHJvcF07XG4gICAgICAgICAgZGVsZXRlIGNsb25lLmlkO1xuICAgICAgICAgIGhlYWRlckdyb3VwW21hcmtlciAtIDFdID0gbmV3IFBibENvbHVtbkdyb3VwKGNsb25lLCBbLi4ucHJldi5jb2x1bW5zLCBjb2x1bW5dLCB0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBkOiBQYmxDb2x1bW5Hcm91cERlZmluaXRpb24gPSB7IHJvd0luZGV4LCBraW5kOiAnaGVhZGVyJywgY29sdW1uSWRzOiBbb3JnUHJvcF19O1xuICAgICAgICAgIGhlYWRlckdyb3VwLnNwbGljZShtYXJrZXIsIDAsIG5ldyBQYmxDb2x1bW5Hcm91cChkLCBbY29sdW1uXSwgdHJ1ZSkpXG4gICAgICAgICAgbWFya2VyICs9IDE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlckdyb3VwO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb2x1bW5GYWN0b3J5KCk6IFBibENvbHVtbkZhY3Rvcnkge1xuICByZXR1cm4gbmV3IFBibENvbHVtbkZhY3RvcnkoKVxufVxuIl19