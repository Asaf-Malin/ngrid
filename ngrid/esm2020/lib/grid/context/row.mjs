import { PblCellContext } from './cell';
export class PblRowContext {
    constructor(_data, dsIndex, extApi) {
        this.extApi = extApi;
        this.external = {};
        this.dsIndex = dsIndex;
        this._$implicit = _data;
        this.identity = this.extApi.contextApi.getRowIdentity(dsIndex, _data);
        this.grid = extApi.grid;
        this._rebuildCells(this.extApi.grid.columnApi.columns);
    }
    /** Data for the row that this cell is located within. */
    get $implicit() { return this._$implicit; }
    set $implicit(value) {
        if (this._$implicit !== value) {
            this._$implicit = value;
            this.updateRowData();
        }
    }
    ;
    /** Index of the data object in the provided data array. */
    get dataIndex() { return this.index; }
    set dataIndex(value) { this.index = value; }
    /**
     * Returns the length of cells context stored in this row
     */
    get length() { return this.cells?.length ?? 0; }
    static defaultState(identity, dsIndex, cellsCount) {
        const cells = [];
        for (let i = 0; i < cellsCount; i++) {
            cells.push(PblCellContext.defaultState());
        }
        return { identity, dsIndex, cells, firstRender: true, external: {} };
    }
    getExternal(key) {
        return this.external[key];
    }
    setExternal(key, value, saveState = false) {
        this.external[key] = value;
        if (saveState) {
            this.saveState();
        }
    }
    getState() {
        return {
            identity: this.identity,
            dsIndex: this.dsIndex,
            firstRender: this.firstRender,
            cells: this.cells.map(c => c.getState()),
            external: this.external,
        };
    }
    fromState(state) {
        this.firstRender = state.firstRender;
        this.dsIndex = state.dsIndex;
        this.external = state.external;
        for (let i = 0, len = this.cells.length; i < len; i++) {
            this.cells[i].fromState(state.cells[i], this);
        }
    }
    saveState() {
        this.extApi.contextApi.saveState(this);
    }
    /**
     * Returns the cell context for the column at the specified position.
     * > The position is relative to ALL columns (NOT RENDERED COLUMNS)
     */
    cell(index) {
        const idx = typeof index === 'number' ? index : this.grid.columnApi.indexOf(index);
        return this.cells[idx];
    }
    getCells() {
        return (this.cells && this.cells.slice()) || [];
    }
    updateCell(cell) {
        this.cells[cell.index] = cell.clone();
    }
    attachRow(row) {
        this.detachRow(this._attachedRow);
        this._attachedRow = row;
        if (this._updatePending) {
            this.updateRowData();
        }
    }
    detachRow(row) {
        if (row && this._attachedRow === row) {
            this.saveState();
            this._attachedRow = undefined;
        }
    }
    _rebuildCells(columns) {
        const cells = this.cells = [];
        const len = columns.length;
        for (let columnIndex = 0; columnIndex < len; columnIndex++) {
            const cellContext = PblCellContext.create(this, columns[columnIndex], this.extApi);
            cells.push(cellContext);
        }
    }
    updateRowData() {
        if (this._attachedRow) {
            this._updatePending = false;
            this.extApi.contextApi._updateRowContext(this, this._attachedRow.rowIndex);
            this._attachedRow.updateRow();
        }
        else {
            this._updatePending = !!this._$implicit;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3JpZC9zcmMvbGliL2dyaWQvY29udGV4dC9yb3cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUd4QyxNQUFNLE9BQU8sYUFBYTtJQWlEeEIsWUFBWSxLQUFRLEVBQUUsT0FBZSxFQUFVLE1BQStCO1FBQS9CLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBWnRFLGFBQVEsR0FBUSxFQUFFLENBQUM7UUFhekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXRFLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBdkRELHlEQUF5RDtJQUN6RCxJQUFJLFNBQVMsS0FBb0IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMxRCxJQUFJLFNBQVMsQ0FBQyxLQUFvQjtRQUNoQyxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssS0FBSyxFQUFFO1lBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUM7SUFBQSxDQUFDO0lBSUYsMkRBQTJEO0lBQzNELElBQUksU0FBUyxLQUFLLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDdEMsSUFBSSxTQUFTLENBQUMsS0FBYSxJQUFJLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQztJQXlCcEQ7O09BRUc7SUFDSCxJQUFJLE1BQU0sS0FBYSxPQUFPLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFnQnhELE1BQU0sQ0FBQyxZQUFZLENBQVUsUUFBYSxFQUFFLE9BQWUsRUFBRSxVQUFrQjtRQUM3RSxNQUFNLEtBQUssR0FBMEIsRUFBRSxDQUFDO1FBQ3hDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbkMsS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztTQUMzQztRQUNELE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQztJQUN2RSxDQUFDO0lBRUQsV0FBVyxDQUEwQyxHQUFNO1FBQ3pELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRUQsV0FBVyxDQUEwQyxHQUFNLEVBQUUsS0FBaUMsRUFBRSxTQUFTLEdBQUcsS0FBSztRQUMvRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUMzQixJQUFJLFNBQVMsRUFBRTtZQUNiLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFRCxRQUFRO1FBQ04sT0FBTztZQUNMLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDckIsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBRTtZQUMxQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7U0FDeEIsQ0FBQztJQUNKLENBQUM7SUFFRCxTQUFTLENBQUMsS0FBeUI7UUFDakMsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUM3QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7UUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDckQsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUM7SUFFRCxTQUFTO1FBQ1AsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFJLENBQUMsS0FBeUI7UUFDNUIsTUFBTSxHQUFHLEdBQUcsT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2xELENBQUM7SUFFRCxVQUFVLENBQUMsSUFBdUI7UUFDaEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxTQUFTLENBQUMsR0FBNEI7UUFDcEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUM7SUFFRCxTQUFTLENBQUMsR0FBNEI7UUFDcEMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxHQUFHLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUVELGFBQWEsQ0FBQyxPQUFvQjtRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBRTNCLEtBQUssSUFBSSxXQUFXLEdBQUcsQ0FBQyxFQUFFLFdBQVcsR0FBRyxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUU7WUFDMUQsTUFBTSxXQUFXLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBSSxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN0RixLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3pCO0lBQ0gsQ0FBQztJQUVPLGFBQWE7UUFDbkIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1lBQzVCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNFLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDL0I7YUFBTTtZQUNMLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7U0FDekM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBfUGJsTmdyaWRDb21wb25lbnQgfSBmcm9tICcuLi8uLi90b2tlbnMnO1xuaW1wb3J0IHsgUGJsQ29sdW1uIH0gZnJvbSAnLi4vY29sdW1uL21vZGVsJztcbmltcG9ydCB7IFBibE5ncmlkRXh0ZW5zaW9uQXBpIH0gZnJvbSAnLi4vLi4vZXh0L2dyaWQtZXh0LWFwaSc7XG5pbXBvcnQgeyBDZWxsQ29udGV4dFN0YXRlLCBSb3dDb250ZXh0U3RhdGUsIFBibE5ncmlkUm93Q29udGV4dCwgRXh0ZXJuYWxSb3dDb250ZXh0U3RhdGUgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IFBibENlbGxDb250ZXh0IH0gZnJvbSAnLi9jZWxsJztcbmltcG9ydCB7IFBibE5ncmlkUm93Q29tcG9uZW50IH0gZnJvbSAnLi4vcm93L3Jvdy5jb21wb25lbnQnO1xuXG5leHBvcnQgY2xhc3MgUGJsUm93Q29udGV4dDxUPiBpbXBsZW1lbnRzIFBibE5ncmlkUm93Q29udGV4dDxUPiB7XG4gIC8qKiBEYXRhIGZvciB0aGUgcm93IHRoYXQgdGhpcyBjZWxsIGlzIGxvY2F0ZWQgd2l0aGluLiAqL1xuICBnZXQgJGltcGxpY2l0KCk6IFQgfCB1bmRlZmluZWQgeyByZXR1cm4gdGhpcy5fJGltcGxpY2l0OyB9XG4gIHNldCAkaW1wbGljaXQodmFsdWU6IFQgfCB1bmRlZmluZWQpIHtcbiAgICBpZiAodGhpcy5fJGltcGxpY2l0ICE9PSB2YWx1ZSkge1xuICAgICAgdGhpcy5fJGltcGxpY2l0ID0gdmFsdWU7XG4gICAgICB0aGlzLnVwZGF0ZVJvd0RhdGEoKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqIEluZGV4IG9mIHRoZSBkYXRhIG9iamVjdCBpbiB0aGUgcHJvdmlkZWQgZGF0YSBhcnJheS4gKi9cbiAgaW5kZXg/OiBudW1iZXI7XG4gIC8qKiBJbmRleCBvZiB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHByb3ZpZGVkIGRhdGEgYXJyYXkuICovXG4gIGdldCBkYXRhSW5kZXgoKSB7IHJldHVybiB0aGlzLmluZGV4OyB9XG4gIHNldCBkYXRhSW5kZXgodmFsdWU6IG51bWJlcikgeyB0aGlzLmluZGV4ID0gdmFsdWU7IH1cblxuICAvKiogSW5kZXggbG9jYXRpb24gb2YgdGhlIHJlbmRlcmVkIHJvdyB0aGF0IHRoaXMgY2VsbCBpcyBsb2NhdGVkIHdpdGhpbi4gKi9cbiAgcmVuZGVySW5kZXg/OiBudW1iZXI7XG4gIC8qKiBMZW5ndGggb2YgdGhlIG51bWJlciBvZiB0b3RhbCByb3dzLiAqL1xuICBjb3VudD86IG51bWJlcjtcbiAgLyoqIFRydWUgaWYgdGhpcyBjZWxsIGlzIGNvbnRhaW5lZCBpbiB0aGUgZmlyc3Qgcm93LiAqL1xuICBmaXJzdD86IGJvb2xlYW47XG4gIC8qKiBUcnVlIGlmIHRoaXMgY2VsbCBpcyBjb250YWluZWQgaW4gdGhlIGxhc3Qgcm93LiAqL1xuICBsYXN0PzogYm9vbGVhbjtcbiAgLyoqIFRydWUgaWYgdGhpcyBjZWxsIGlzIGNvbnRhaW5lZCBpbiBhIHJvdyB3aXRoIGFuIGV2ZW4tbnVtYmVyZWQgaW5kZXguICovXG4gIGV2ZW4/OiBib29sZWFuO1xuICAvKiogVHJ1ZSBpZiB0aGlzIGNlbGwgaXMgY29udGFpbmVkIGluIGEgcm93IHdpdGggYW4gb2RkLW51bWJlcmVkIGluZGV4LiAqL1xuICBvZGQ/OiBib29sZWFuO1xuXG4gIC8qKiBUaGUgaW5kZXggYXQgdGhlIGRhdGFzb3VyY2UgKi9cbiAgZHNJbmRleDogbnVtYmVyO1xuICBpZGVudGl0eTogYW55O1xuICBmaXJzdFJlbmRlcjogYm9vbGVhbjtcbiAgb3V0T2ZWaWV3OiBib29sZWFuO1xuXG4gIHJlYWRvbmx5IGdyaWQ6IF9QYmxOZ3JpZENvbXBvbmVudDxUPjtcbiAgcHJpdmF0ZSBfYXR0YWNoZWRSb3c6IFBibE5ncmlkUm93Q29tcG9uZW50PFQ+O1xuICBwcml2YXRlIGV4dGVybmFsOiBhbnkgPSB7fTtcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbGVuZ3RoIG9mIGNlbGxzIGNvbnRleHQgc3RvcmVkIGluIHRoaXMgcm93XG4gICAqL1xuICBnZXQgbGVuZ3RoKCk6IG51bWJlciB7IHJldHVybiB0aGlzLmNlbGxzPy5sZW5ndGggPz8gMDsgfVxuXG4gIHByaXZhdGUgY2VsbHM6IFBibENlbGxDb250ZXh0PFQ+W107XG5cbiAgcHJpdmF0ZSBfJGltcGxpY2l0PzogVDtcbiAgcHJpdmF0ZSBfdXBkYXRlUGVuZGluZzogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihfZGF0YTogVCwgZHNJbmRleDogbnVtYmVyLCBwcml2YXRlIGV4dEFwaTogUGJsTmdyaWRFeHRlbnNpb25BcGk8VD4pIHtcbiAgICB0aGlzLmRzSW5kZXggPSBkc0luZGV4O1xuICAgIHRoaXMuXyRpbXBsaWNpdCA9IF9kYXRhO1xuICAgIHRoaXMuaWRlbnRpdHkgPSB0aGlzLmV4dEFwaS5jb250ZXh0QXBpLmdldFJvd0lkZW50aXR5KGRzSW5kZXgsIF9kYXRhKTtcblxuICAgIHRoaXMuZ3JpZCA9IGV4dEFwaS5ncmlkO1xuICAgIHRoaXMuX3JlYnVpbGRDZWxscyh0aGlzLmV4dEFwaS5ncmlkLmNvbHVtbkFwaS5jb2x1bW5zKTtcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0U3RhdGU8VCA9IGFueT4oaWRlbnRpdHk6IGFueSwgZHNJbmRleDogbnVtYmVyLCBjZWxsc0NvdW50OiBudW1iZXIpOiBSb3dDb250ZXh0U3RhdGU8VD4ge1xuICAgIGNvbnN0IGNlbGxzOiBDZWxsQ29udGV4dFN0YXRlPFQ+W10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNlbGxzQ291bnQ7IGkrKykge1xuICAgICAgY2VsbHMucHVzaChQYmxDZWxsQ29udGV4dC5kZWZhdWx0U3RhdGUoKSk7XG4gICAgfVxuICAgIHJldHVybiB7IGlkZW50aXR5LCBkc0luZGV4LCBjZWxscywgZmlyc3RSZW5kZXI6IHRydWUsIGV4dGVybmFsOiB7fSB9O1xuICB9XG5cbiAgZ2V0RXh0ZXJuYWw8UCBleHRlbmRzIGtleW9mIEV4dGVybmFsUm93Q29udGV4dFN0YXRlPihrZXk6IFApOiBFeHRlcm5hbFJvd0NvbnRleHRTdGF0ZVtQXSB7XG4gICAgcmV0dXJuIHRoaXMuZXh0ZXJuYWxba2V5XTtcbiAgfVxuXG4gIHNldEV4dGVybmFsPFAgZXh0ZW5kcyBrZXlvZiBFeHRlcm5hbFJvd0NvbnRleHRTdGF0ZT4oa2V5OiBQLCB2YWx1ZTogRXh0ZXJuYWxSb3dDb250ZXh0U3RhdGVbUF0sIHNhdmVTdGF0ZSA9IGZhbHNlKSB7XG4gICAgdGhpcy5leHRlcm5hbFtrZXldID0gdmFsdWU7XG4gICAgaWYgKHNhdmVTdGF0ZSkge1xuICAgICAgdGhpcy5zYXZlU3RhdGUoKTtcbiAgICB9XG4gIH1cblxuICBnZXRTdGF0ZSgpOiBSb3dDb250ZXh0U3RhdGU8VD4ge1xuICAgIHJldHVybiB7XG4gICAgICBpZGVudGl0eTogdGhpcy5pZGVudGl0eSxcbiAgICAgIGRzSW5kZXg6IHRoaXMuZHNJbmRleCxcbiAgICAgIGZpcnN0UmVuZGVyOiB0aGlzLmZpcnN0UmVuZGVyLFxuICAgICAgY2VsbHM6IHRoaXMuY2VsbHMubWFwKCBjID0+IGMuZ2V0U3RhdGUoKSApLFxuICAgICAgZXh0ZXJuYWw6IHRoaXMuZXh0ZXJuYWwsXG4gICAgfTtcbiAgfVxuXG4gIGZyb21TdGF0ZShzdGF0ZTogUm93Q29udGV4dFN0YXRlPFQ+KTogdm9pZCB7XG4gICAgdGhpcy5maXJzdFJlbmRlciA9IHN0YXRlLmZpcnN0UmVuZGVyO1xuICAgIHRoaXMuZHNJbmRleCA9IHN0YXRlLmRzSW5kZXg7XG4gICAgdGhpcy5leHRlcm5hbCA9IHN0YXRlLmV4dGVybmFsO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0aGlzLmNlbGxzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICB0aGlzLmNlbGxzW2ldLmZyb21TdGF0ZShzdGF0ZS5jZWxsc1tpXSwgdGhpcyk7XG4gICAgfVxuICB9XG5cbiAgc2F2ZVN0YXRlKCkge1xuICAgIHRoaXMuZXh0QXBpLmNvbnRleHRBcGkuc2F2ZVN0YXRlKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGNlbGwgY29udGV4dCBmb3IgdGhlIGNvbHVtbiBhdCB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uLlxuICAgKiA+IFRoZSBwb3NpdGlvbiBpcyByZWxhdGl2ZSB0byBBTEwgY29sdW1ucyAoTk9UIFJFTkRFUkVEIENPTFVNTlMpXG4gICAqL1xuICBjZWxsKGluZGV4OiBudW1iZXIgfCBQYmxDb2x1bW4pOiBQYmxDZWxsQ29udGV4dDxUPiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgaWR4ID0gdHlwZW9mIGluZGV4ID09PSAnbnVtYmVyJyA/IGluZGV4IDogdGhpcy5ncmlkLmNvbHVtbkFwaS5pbmRleE9mKGluZGV4KTtcbiAgICByZXR1cm4gdGhpcy5jZWxsc1tpZHhdO1xuICB9XG5cbiAgZ2V0Q2VsbHMoKTogUGJsQ2VsbENvbnRleHQ8VD5bXSB7XG4gICAgcmV0dXJuICh0aGlzLmNlbGxzICYmIHRoaXMuY2VsbHMuc2xpY2UoKSkgfHwgW107XG4gIH1cblxuICB1cGRhdGVDZWxsKGNlbGw6IFBibENlbGxDb250ZXh0PFQ+KTogdm9pZCB7XG4gICAgdGhpcy5jZWxsc1tjZWxsLmluZGV4XSA9IGNlbGwuY2xvbmUoKTtcbiAgfVxuXG4gIGF0dGFjaFJvdyhyb3c6IFBibE5ncmlkUm93Q29tcG9uZW50PFQ+KSB7XG4gICAgdGhpcy5kZXRhY2hSb3codGhpcy5fYXR0YWNoZWRSb3cpO1xuICAgIHRoaXMuX2F0dGFjaGVkUm93ID0gcm93O1xuICAgIGlmICh0aGlzLl91cGRhdGVQZW5kaW5nKSB7XG4gICAgICB0aGlzLnVwZGF0ZVJvd0RhdGEoKTtcbiAgICB9XG4gIH1cblxuICBkZXRhY2hSb3cocm93OiBQYmxOZ3JpZFJvd0NvbXBvbmVudDxUPikge1xuICAgIGlmIChyb3cgJiYgdGhpcy5fYXR0YWNoZWRSb3cgPT09IHJvdykge1xuICAgICAgdGhpcy5zYXZlU3RhdGUoKTtcbiAgICAgIHRoaXMuX2F0dGFjaGVkUm93ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIF9yZWJ1aWxkQ2VsbHMoY29sdW1uczogUGJsQ29sdW1uW10pIHtcbiAgICBjb25zdCBjZWxscyA9IHRoaXMuY2VsbHMgPSBbXTtcbiAgICBjb25zdCBsZW4gPSBjb2x1bW5zLmxlbmd0aDtcblxuICAgIGZvciAobGV0IGNvbHVtbkluZGV4ID0gMDsgY29sdW1uSW5kZXggPCBsZW47IGNvbHVtbkluZGV4KyspIHtcbiAgICAgIGNvbnN0IGNlbGxDb250ZXh0ID0gUGJsQ2VsbENvbnRleHQuY3JlYXRlPFQ+KHRoaXMsIGNvbHVtbnNbY29sdW1uSW5kZXhdLCB0aGlzLmV4dEFwaSk7XG4gICAgICBjZWxscy5wdXNoKGNlbGxDb250ZXh0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVJvd0RhdGEoKSB7XG4gICAgaWYgKHRoaXMuX2F0dGFjaGVkUm93KSB7XG4gICAgICB0aGlzLl91cGRhdGVQZW5kaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmV4dEFwaS5jb250ZXh0QXBpLl91cGRhdGVSb3dDb250ZXh0KHRoaXMsIHRoaXMuX2F0dGFjaGVkUm93LnJvd0luZGV4KTtcbiAgICAgIHRoaXMuX2F0dGFjaGVkUm93LnVwZGF0ZVJvdygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl91cGRhdGVQZW5kaW5nID0gISF0aGlzLl8kaW1wbGljaXQ7XG4gICAgfVxuICB9XG59XG4iXX0=